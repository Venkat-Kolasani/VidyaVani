<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VidyaVani Phone Call Simulator</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .phone-container {
            background: #2c3e50;
            border-radius: 30px;
            padding: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            max-width: 400px;
            width: 100%;
            position: relative;
        }

        .phone-header {
            text-align: center;
            color: white;
            margin-bottom: 20px;
        }

        .phone-header h1 {
            margin: 0;
            font-size: 1.5em;
            font-weight: 300;
        }

        .phone-number {
            background: #34495e;
            color: #4CAF50;
            padding: 10px;
            border-radius: 10px;
            text-align: center;
            font-family: 'Courier New', monospace;
            font-size: 1.2em;
            margin-bottom: 20px;
            border: 2px solid #4CAF50;
        }

        .phone-screen {
            background: #1a252f;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            min-height: 200px;
            border: 3px solid #34495e;
            position: relative;
            overflow: hidden;
        }

        .screen-content {
            color: #ecf0f1;
            line-height: 1.6;
            font-size: 1.1em;
        }

        .call-status {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px;
            background: rgba(52, 73, 94, 0.5);
            border-radius: 8px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 10px;
            animation: pulse 2s infinite;
        }

        .status-connected {
            background-color: #4CAF50;
        }

        .status-processing {
            background-color: #FF9800;
        }

        .status-listening {
            background-color: #2196F3;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .menu-text {
            margin: 15px 0;
            padding: 15px;
            background: rgba(76, 175, 80, 0.1);
            border-left: 4px solid #4CAF50;
            border-radius: 5px;
        }

        .keypad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .key {
            background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%);
            border: 2px solid #4CAF50;
            color: white;
            padding: 20px;
            border-radius: 50%;
            font-size: 1.5em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 60px;
            position: relative;
        }

        .key:hover {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.4);
        }

        .key:active {
            transform: scale(0.95);
        }

        .key-letters {
            font-size: 0.6em;
            position: absolute;
            bottom: 8px;
            color: #bdc3c7;
        }

        .call-controls {
            display: flex;
            justify-content: space-around;
            margin-top: 20px;
        }

        .call-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .call-btn.start {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
        }

        .call-btn.end {
            background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
            color: white;
        }

        .call-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .demo-questions {
            margin-top: 20px;
            background: rgba(52, 73, 94, 0.3);
            border-radius: 10px;
            padding: 15px;
        }

        .demo-questions h3 {
            color: #4CAF50;
            margin: 0 0 15px 0;
            font-size: 1.1em;
        }

        .question-btn {
            display: block;
            width: 100%;
            background: rgba(33, 150, 243, 0.2);
            color: #ecf0f1;
            border: 1px solid #2196F3;
            padding: 8px 12px;
            margin: 5px 0;
            border-radius: 5px;
            cursor: pointer;
            text-align: left;
            font-size: 0.9em;
            transition: all 0.3s;
        }

        .question-btn:hover {
            background: rgba(33, 150, 243, 0.4);
            border-color: #4CAF50;
        }

        .processing-indicator {
            display: none;
            text-align: center;
            padding: 20px;
            color: #FF9800;
        }

        .processing-dots {
            display: inline-block;
            animation: dots 1.5s infinite;
        }

        @keyframes dots {

            0%,
            20% {
                content: '.';
            }

            40% {
                content: '..';
            }

            60%,
            100% {
                content: '...';
            }
        }

        .response-display {
            display: none;
            background: rgba(76, 175, 80, 0.1);
            border: 1px solid #4CAF50;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            color: #ecf0f1;
        }

        .audio-controls {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
        }

        .play-btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.9em;
        }

        .play-btn:hover {
            background: #45a049;
        }

        .call-flow-info {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px;
            border-radius: 10px;
            max-width: 300px;
            font-size: 0.9em;
        }

        .flow-step {
            margin: 8px 0;
            padding: 5px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .flow-step.active {
            color: #4CAF50;
            font-weight: bold;
        }

        @media (max-width: 768px) {
            .call-flow-info {
                position: relative;
                top: auto;
                right: auto;
                margin: 20px 0;
            }

            body {
                padding: 10px;
            }
        }

        .dtmf-feedback {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(76, 175, 80, 0.9);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 2em;
            font-weight: bold;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }

        .dtmf-feedback.show {
            opacity: 1;
        }
    </style>
</head>

<body>
    <!-- Call Flow Information Panel -->
    <div class="call-flow-info">
        <h3>üìû IVR Call Flow</h3>
        <div class="flow-step" id="step-1">1. Dial VidyaVani Number</div>
        <div class="flow-step" id="step-2">2. Welcome Message</div>
        <div class="flow-step" id="step-3">3. Language Selection (1/2)</div>
        <div class="flow-step" id="step-4">4. Grade Confirmation</div>
        <div class="flow-step" id="step-5">5. Interaction Mode</div>
        <div class="flow-step" id="step-6">6. Ask Question</div>
        <div class="flow-step" id="step-7">7. AI Processing</div>
        <div class="flow-step" id="step-8">8. Response Delivery</div>
        <div class="flow-step" id="step-9">9. Follow-up Menu</div>
    </div>

    <div class="phone-container">
        <div class="phone-header">
            <h1>üì± VidyaVani IVR Simulator</h1>
        </div>

        <div class="phone-number">
            üìû +91-XXXX-VIDYA (84392)
        </div>

        <div class="phone-screen">
            <div class="call-status">
                <div class="status-indicator status-connected" id="call-status-indicator"></div>
                <span id="call-status-text">Ready to Call</span>
            </div>

            <div class="screen-content" id="screen-content">
                <div class="menu-text">
                    <strong>Welcome to VidyaVani!</strong><br>
                    Your AI-powered learning assistant for Class 10 Science.<br><br>
                    Press the <strong>üìû CALL</strong> button to start your learning session.
                </div>
            </div>

            <div class="processing-indicator" id="processing-indicator">
                <div>ü§ñ AI Processing your question</div>
                <div class="processing-dots">...</div>
            </div>

            <div class="response-display" id="response-display">
                <div id="response-text"></div>
                <div class="audio-controls">
                    <button class="play-btn" onclick="playResponse()">
                        üîä Play Response
                    </button>
                </div>
            </div>

            <!-- DTMF Feedback -->
            <div class="dtmf-feedback" id="dtmf-feedback"></div>
        </div>

        <!-- Phone Keypad -->
        <div class="keypad">
            <div class="key" onclick="pressKey('1')">
                1
                <div class="key-letters"></div>
            </div>
            <div class="key" onclick="pressKey('2')">
                2
                <div class="key-letters">ABC</div>
            </div>
            <div class="key" onclick="pressKey('3')">
                3
                <div class="key-letters">DEF</div>
            </div>
            <div class="key" onclick="pressKey('4')">
                4
                <div class="key-letters">GHI</div>
            </div>
            <div class="key" onclick="pressKey('5')">
                5
                <div class="key-letters">JKL</div>
            </div>
            <div class="key" onclick="pressKey('6')">
                6
                <div class="key-letters">MNO</div>
            </div>
            <div class="key" onclick="pressKey('7')">
                7
                <div class="key-letters">PQRS</div>
            </div>
            <div class="key" onclick="pressKey('8')">
                8
                <div class="key-letters">TUV</div>
            </div>
            <div class="key" onclick="pressKey('9')">
                9
                <div class="key-letters">WXYZ</div>
            </div>
            <div class="key" onclick="pressKey('*')">
                *
            </div>
            <div class="key" onclick="pressKey('0')">
                0
                <div class="key-letters">+</div>
            </div>
            <div class="key" onclick="pressKey('#')">
                #
            </div>
        </div>

        <!-- Call Control Buttons -->
        <div class="call-controls">
            <button class="call-btn start" onclick="startCall()" id="start-call-btn">
                üìû
            </button>
            <button class="call-btn end" onclick="endCall()" id="end-call-btn" style="display: none;">
                üìµ
            </button>
        </div>

        <!-- Demo Questions (shown during question recording phase) -->
        <div class="demo-questions" id="demo-questions" style="display: none;">
            <h3>üéØ Quick Demo Questions</h3>

            <!-- Voice Recording Option -->
            <div class="voice-recording"
                style="margin-bottom: 15px; padding: 10px; background: rgba(76, 175, 80, 0.1); border-radius: 8px;">
                <button id="record-btn" class="question-btn" onclick="toggleRecording()"
                    style="background: rgba(244, 67, 54, 0.2); border-color: #f44336;">
                    üé§ Click to Record Your Question
                </button>
                <div id="recording-status" style="display: none; color: #f44336; margin-top: 5px; font-size: 0.9em;">
                    üî¥ Recording... Click again to stop
                </div>
            </div>

            <div id="question-list">
                <!-- Questions will be loaded here -->
            </div>
        </div>
    </div>

    <script>
        let callActive = false;
        let currentStep = 0;
        let currentLanguage = 'english';
        let isProcessing = false;
        let currentResponse = null;

        // IVR Flow Steps
        const flowSteps = [
            'idle',
            'welcome',
            'language_selection',
            'grade_confirmation',
            'interaction_mode',
            'topic_browsing',
            'question_recording',
            'processing',
            'response_delivery',
            'follow_up'
        ];

        // Initialize
        document.addEventListener('DOMContentLoaded', function () {
            loadDemoQuestions();
            updateFlowStep(0);
        });

        async function loadDemoQuestions() {
            try {
                const response = await fetch('/api/demo/questions');
                const data = await response.json();

                const questionList = document.getElementById('question-list');
                questionList.innerHTML = '';

                // Show first 8 questions for demo
                data.demo_questions.slice(0, 8).forEach((question, index) => {
                    const btn = document.createElement('button');
                    btn.className = 'question-btn';
                    btn.textContent = `${index + 1}. ${question}`;
                    btn.onclick = () => askDemoQuestion(question);
                    questionList.appendChild(btn);
                });

            } catch (error) {
                console.error('Failed to load demo questions:', error);
            }
        }

        function startCall() {
            if (callActive) return;

            callActive = true;
            document.getElementById('start-call-btn').style.display = 'none';
            document.getElementById('end-call-btn').style.display = 'block';

            updateCallStatus('status-connected', 'Call Connected');
            updateFlowStep(1);

            // Simulate call connection delay
            setTimeout(() => {
                playWelcomeMessage();
            }, 1000);
        }

        function endCall() {
            if (!callActive) return;

            callActive = false;
            currentStep = 0;
            isProcessing = false;

            document.getElementById('start-call-btn').style.display = 'block';
            document.getElementById('end-call-btn').style.display = 'none';
            document.getElementById('demo-questions').style.display = 'none';
            document.getElementById('response-display').style.display = 'none';
            document.getElementById('processing-indicator').style.display = 'none';

            updateCallStatus('status-connected', 'Call Ended');
            updateFlowStep(0);

            setTimeout(() => {
                updateCallStatus('status-connected', 'Ready to Call');
                updateScreenContent(`
                    <div class="menu-text">
                        <strong>Welcome to VidyaVani!</strong><br>
                        Your AI-powered learning assistant for Class 10 Science.<br><br>
                        Press the <strong>üìû CALL</strong> button to start your learning session.
                    </div>
                `);
            }, 2000);
        }

        function playWelcomeMessage() {
            updateScreenContent(`
                <div class="menu-text">
                    üéµ <strong>Welcome to VidyaVani!</strong><br><br>
                    Your AI-powered learning assistant for Class 10 Science.<br><br>
                    Press <strong>1</strong> for English<br>
                    Press <strong>2</strong> for Telugu
                </div>
            `);
            updateFlowStep(2);
        }

        function pressKey(key) {
            if (!callActive) return;

            // Show DTMF feedback
            showDTMFFeedback(key);

            // Handle based on current step
            switch (flowSteps[currentStep]) {
                case 'language_selection':
                    handleLanguageSelection(key);
                    break;
                case 'grade_confirmation':
                    handleGradeConfirmation(key);
                    break;
                case 'interaction_mode':
                    handleInteractionMode(key);
                    break;
                case 'follow_up':
                    handleFollowUp(key);
                    break;
                case 'topic_browsing':
                    handleTopicBrowsing(key);
                    break;
                default:
                    if (currentStep === 1) {
                        // Still in welcome, treat as language selection
                        handleLanguageSelection(key);
                    }
            }
        }

        function showDTMFFeedback(key) {
            const feedback = document.getElementById('dtmf-feedback');
            feedback.textContent = key;
            feedback.classList.add('show');

            setTimeout(() => {
                feedback.classList.remove('show');
            }, 500);
        }

        function handleLanguageSelection(key) {
            if (key === '1') {
                currentLanguage = 'english';
                updateScreenContent(`
                    <div class="menu-text">
                        ‚úÖ <strong>English Selected</strong><br><br>
                        You are calling for <strong>Class 10 Science</strong> learning assistance.<br><br>
                        Press <strong>1</strong> to confirm<br>
                        Press <strong>2</strong> to change grade
                    </div>
                `);
                updateFlowStep(3);
            } else if (key === '2') {
                currentLanguage = 'telugu';
                updateScreenContent(`
                    <div class="menu-text">
                        ‚úÖ <strong>Telugu Selected</strong><br><br>
                        ‡∞Æ‡±Ä‡∞∞‡±Å <strong>‡∞ï‡±ç‡∞≤‡∞æ‡∞∏‡±ç 10 ‡∞∏‡±à‡∞®‡±ç‡∞∏‡±ç</strong> ‡∞∏‡∞π‡∞æ‡∞Ø‡∞Ç ‡∞ï‡±ã‡∞∏‡∞Ç ‡∞ï‡∞æ‡∞≤‡±ç ‡∞ö‡±á‡∞∏‡±ç‡∞§‡±Å‡∞®‡±ç‡∞®‡∞æ‡∞∞‡±Å.<br><br>
                        ‡∞®‡∞ø‡∞∞‡±ç‡∞ß‡∞æ‡∞∞‡∞ø‡∞Ç‡∞ö‡∞°‡∞æ‡∞®‡∞ø‡∞ï‡∞ø <strong>1</strong> ‡∞®‡±ä‡∞ï‡±ç‡∞ï‡∞Ç‡∞°‡∞ø<br>
                        ‡∞ó‡±ç‡∞∞‡±á‡∞°‡±ç ‡∞Æ‡∞æ‡∞∞‡±ç‡∞ö‡∞°‡∞æ‡∞®‡∞ø‡∞ï‡∞ø <strong>2</strong> ‡∞®‡±ä‡∞ï‡±ç‡∞ï‡∞Ç‡∞°‡∞ø
                    </div>
                `);
                updateFlowStep(3);
            }
        }

        function handleGradeConfirmation(key) {
            if (key === '1') {
                const message = currentLanguage === 'english' ?
                    `<div class="menu-text">
                        üìö <strong>Class 10 Science Confirmed</strong><br><br>
                        How would you like to interact?<br><br>
                        Press <strong>1</strong> to browse topics<br>
                        Press <strong>2</strong> to ask a question directly
                    </div>` :
                    `<div class="menu-text">
                        üìö <strong>‡∞ï‡±ç‡∞≤‡∞æ‡∞∏‡±ç 10 ‡∞∏‡±à‡∞®‡±ç‡∞∏‡±ç ‡∞®‡∞ø‡∞∞‡±ç‡∞ß‡∞æ‡∞∞‡∞ø‡∞Ç‡∞ö‡∞¨‡∞°‡∞ø‡∞Ç‡∞¶‡∞ø</strong><br><br>
                        ‡∞Æ‡±Ä‡∞∞‡±Å ‡∞é‡∞≤‡∞æ ‡∞∏‡∞Ç‡∞≠‡∞æ‡∞∑‡∞ø‡∞Ç‡∞ö‡∞æ‡∞≤‡∞®‡±Å‡∞ï‡±Å‡∞Ç‡∞ü‡±Å‡∞®‡±ç‡∞®‡∞æ‡∞∞‡±Å?<br><br>
                        ‡∞µ‡∞ø‡§∑‡∞Ø‡∞æ‡∞≤‡±Å ‡∞ö‡±Ç‡∞°‡∞ü‡∞æ‡∞®‡∞ø‡∞ï‡∞ø <strong>1</strong> ‡∞®‡±ä‡∞ï‡±ç‡∞ï‡∞Ç‡∞°‡∞ø<br>
                        ‡∞™‡±ç‡∞∞‡∞§‡±ç‡∞Ø‡∞ï‡±ç‡∞∑‡∞Ç‡∞ó‡∞æ ‡∞™‡±ç‡∞∞‡∞∂‡±ç‡∞® ‡∞Ö‡∞°‡∞ó‡∞°‡∞æ‡∞®‡∞ø‡∞ï‡∞ø <strong>2</strong> ‡∞®‡±ä‡∞ï‡±ç‡∞ï‡∞Ç‡∞°‡∞ø
                    </div>`;

                updateScreenContent(message);
                updateFlowStep(4);
            }
        }

        function handleInteractionMode(key) {
            if (key === '1') {
                // Browse topics mode
                const message = currentLanguage === 'english' ?
                    `<div class="menu-text">
                        üìö <strong>Browse Topics Selected</strong><br><br>
                        <strong>Class 10 Science Topics:</strong><br><br>
                        Press <strong>1</strong> for Physics (Light, Electricity)<br>
                        Press <strong>2</strong> for Chemistry (Acids, Bases, Metals)<br>
                        Press <strong>3</strong> for Biology (Life Processes)<br>
                        Press <strong>9</strong> to ask a direct question<br>
                        Press <strong>0</strong> for main menu
                    </div>` :
                    `<div class="menu-text">
                        üìö <strong>‡∞µ‡∞ø‡∞∑‡∞Ø‡∞æ‡∞≤‡±Å ‡∞ö‡±Ç‡∞°‡∞ü‡∞Ç ‡∞é‡∞Ç‡∞ö‡±Å‡∞ï‡±ã‡∞¨‡∞°‡∞ø‡∞Ç‡∞¶‡∞ø</strong><br><br>
                        <strong>‡∞ï‡±ç‡∞≤‡∞æ‡∞∏‡±ç 10 ‡∞∏‡±à‡∞®‡±ç‡∞∏‡±ç ‡∞µ‡∞ø‡∞∑‡∞Ø‡∞æ‡∞≤‡±Å:</strong><br><br>
                        ‡∞≠‡±å‡∞§‡∞ø‡∞ï ‡∞∂‡∞æ‡∞∏‡±ç‡∞§‡±ç‡∞∞‡∞Ç ‡∞ï‡±ã‡∞∏‡∞Ç <strong>1</strong> ‡∞®‡±ä‡∞ï‡±ç‡∞ï‡∞Ç‡∞°‡∞ø<br>
                        ‡∞∞‡∞∏‡∞æ‡∞Ø‡∞® ‡∞∂‡∞æ‡∞∏‡±ç‡∞§‡±ç‡∞∞‡∞Ç ‡∞ï‡±ã‡∞∏‡∞Ç <strong>2</strong> ‡∞®‡±ä‡∞ï‡±ç‡∞ï‡∞Ç‡∞°‡∞ø<br>
                        ‡∞ú‡±Ä‡∞µ ‡∞∂‡∞æ‡∞∏‡±ç‡∞§‡±ç‡∞∞‡∞Ç ‡∞ï‡±ã‡∞∏‡∞Ç <strong>3</strong> ‡∞®‡±ä‡∞ï‡±ç‡∞ï‡∞Ç‡∞°‡∞ø<br>
                        ‡∞™‡±ç‡∞∞‡∞§‡±ç‡∞Ø‡∞ï‡±ç‡∞∑ ‡∞™‡±ç‡∞∞‡∞∂‡±ç‡∞® ‡∞ï‡±ã‡∞∏‡∞Ç <strong>9</strong> ‡∞®‡±ä‡∞ï‡±ç‡∞ï‡∞Ç‡∞°‡∞ø<br>
                        ‡∞Æ‡±Ü‡∞Ø‡∞ø‡∞®‡±ç ‡∞Æ‡±Ü‡∞®‡±Ç ‡∞ï‡±ã‡∞∏‡∞Ç <strong>0</strong> ‡∞®‡±ä‡∞ï‡±ç‡∞ï‡∞Ç‡∞°‡∞ø
                    </div>`;

                updateScreenContent(message);
                updateCallStatus('status-connected', 'Browsing Topics');
                currentStep = 5; // Set to topic browsing step

            } else if (key === '2') {
                const message = currentLanguage === 'english' ?
                    `<div class="menu-text">
                        üé§ <strong>Question Mode Selected</strong><br><br>
                        Please ask your Class 10 Science question clearly.<br><br>
                        You can use the demo questions below or speak your question.
                    </div>` :
                    `<div class="menu-text">
                        üé§ <strong>‡∞™‡±ç‡∞∞‡∞∂‡±ç‡∞® ‡∞Æ‡±ã‡∞°‡±ç ‡∞é‡∞Ç‡∞ö‡±Å‡∞ï‡±ã‡∞¨‡∞°‡∞ø‡∞Ç‡∞¶‡∞ø</strong><br><br>
                        ‡∞¶‡∞Ø‡∞ö‡±á‡∞∏‡∞ø ‡∞Æ‡±Ä ‡∞ï‡±ç‡∞≤‡∞æ‡∞∏‡±ç 10 ‡∞∏‡±à‡∞®‡±ç‡∞∏‡±ç ‡∞™‡±ç‡∞∞‡∞∂‡±ç‡∞®‡∞®‡±Å ‡∞∏‡±ç‡∞™‡∞∑‡±ç‡∞ü‡∞Ç‡∞ó‡∞æ ‡∞Ö‡∞°‡∞ó‡∞Ç‡∞°‡∞ø.<br><br>
                        ‡∞Æ‡±Ä‡∞∞‡±Å ‡∞ï‡±ç‡∞∞‡∞ø‡∞Ç‡∞¶‡∞ø ‡∞°‡±Ü‡∞Æ‡±ã ‡∞™‡±ç‡∞∞‡∞∂‡±ç‡∞®‡∞≤‡∞®‡±Å ‡∞â‡∞™‡∞Ø‡±ã‡∞ó‡∞ø‡∞Ç‡∞ö‡∞µ‡∞ö‡±ç‡∞ö‡±Å ‡∞≤‡±á‡∞¶‡∞æ ‡∞Æ‡±Ä ‡∞™‡±ç‡∞∞‡∞∂‡±ç‡∞®‡∞®‡±Å ‡∞ö‡±Ü‡∞™‡±ç‡∞™‡∞µ‡∞ö‡±ç‡∞ö‡±Å.
                    </div>`;

                updateScreenContent(message);
                updateCallStatus('status-listening', 'Listening for Question');
                currentStep = 6; // Move to question recording step

                // Show demo questions
                document.getElementById('demo-questions').style.display = 'block';
            }
        }

        function handleTopicBrowsing(key) {
            if (key === '1') {
                // Physics topics
                const message = currentLanguage === 'english' ?
                    `<div class="menu-text">
                        ‚ö° <strong>Physics Topics</strong><br><br>
                        <strong>Available Topics:</strong><br>
                        ‚Ä¢ Light - Reflection and Refraction<br>
                        ‚Ä¢ Electricity and Magnetism<br>
                        ‚Ä¢ Current and Circuits<br><br>
                        Press <strong>1</strong> to ask about Light<br>
                        Press <strong>2</strong> to ask about Electricity<br>
                        Press <strong>9</strong> for direct question<br>
                        Press <strong>0</strong> to go back
                    </div>` :
                    `<div class="menu-text">
                        ‚ö° <strong>‡∞≠‡±å‡∞§‡∞ø‡∞ï ‡∞∂‡∞æ‡∞∏‡±ç‡∞§‡±ç‡∞∞ ‡∞µ‡∞ø‡∞∑‡∞Ø‡∞æ‡∞≤‡±Å</strong><br><br>
                        <strong>‡∞Ö‡∞Ç‡∞¶‡±Å‡∞¨‡∞æ‡∞ü‡±Å‡∞≤‡±ã ‡∞â‡∞®‡±ç‡∞® ‡∞µ‡∞ø‡∞∑‡∞Ø‡∞æ‡∞≤‡±Å:</strong><br>
                        ‚Ä¢ ‡∞ï‡∞æ‡∞Ç‡∞§‡∞ø - ‡∞™‡±ç‡∞∞‡∞§‡∞ø‡∞¨‡∞ø‡∞Ç‡∞¨‡∞Ç ‡∞Æ‡∞∞‡∞ø‡∞Ø‡±Å ‡∞µ‡∞ï‡±ç‡∞∞‡±Ä‡∞≠‡∞µ‡∞®‡∞Ç<br>
                        ‚Ä¢ ‡∞µ‡∞ø‡∞¶‡±ç‡∞Ø‡±Å‡∞§‡±ç ‡∞Æ‡∞∞‡∞ø‡∞Ø‡±Å ‡∞Ö‡∞Ø‡∞∏‡±ç‡∞ï‡∞æ‡∞Ç‡∞§‡∞§‡±ç‡∞µ‡∞Ç<br>
                        ‚Ä¢ ‡∞ï‡∞∞‡±Ü‡∞Ç‡∞ü‡±ç ‡∞Æ‡∞∞‡∞ø‡∞Ø‡±Å ‡∞∏‡∞∞‡±ç‡∞ï‡±ç‡∞Ø‡±Ç‡∞ü‡±ç‡∞≤‡±Å<br><br>
                        ‡∞ï‡∞æ‡∞Ç‡∞§‡∞ø ‡∞ó‡±Å‡∞∞‡∞ø‡∞Ç‡∞ö‡∞ø ‡∞Ö‡∞°‡∞ó‡∞°‡∞æ‡∞®‡∞ø‡∞ï‡∞ø <strong>1</strong> ‡∞®‡±ä‡∞ï‡±ç‡∞ï‡∞Ç‡∞°‡∞ø<br>
                        ‡∞µ‡∞ø‡∞¶‡±ç‡∞Ø‡±Å‡∞§‡±ç ‡∞ó‡±Å‡∞∞‡∞ø‡∞Ç‡∞ö‡∞ø ‡∞Ö‡∞°‡∞ó‡∞°‡∞æ‡∞®‡∞ø‡∞ï‡∞ø <strong>2</strong> ‡∞®‡±ä‡∞ï‡±ç‡∞ï‡∞Ç‡∞°‡∞ø<br>
                        ‡∞™‡±ç‡∞∞‡∞§‡±ç‡∞Ø‡∞ï‡±ç‡∞∑ ‡∞™‡±ç‡∞∞‡∞∂‡±ç‡∞® ‡∞ï‡±ã‡∞∏‡∞Ç <strong>9</strong> ‡∞®‡±ä‡∞ï‡±ç‡∞ï‡∞Ç‡∞°‡∞ø<br>
                        ‡∞µ‡±Ü‡∞®‡±Å‡∞ï‡∞ï‡±Å ‡∞µ‡±Ü‡∞≥‡±ç‡∞≤‡∞°‡∞æ‡∞®‡∞ø‡∞ï‡∞ø <strong>0</strong> ‡∞®‡±ä‡∞ï‡±ç‡∞ï‡∞Ç‡∞°‡∞ø
                    </div>`;

                updateScreenContent(message);

            } else if (key === '2') {
                // Chemistry topics
                const message = currentLanguage === 'english' ?
                    `<div class="menu-text">
                        üß™ <strong>Chemistry Topics</strong><br><br>
                        <strong>Available Topics:</strong><br>
                        ‚Ä¢ Acids, Bases and Salts<br>
                        ‚Ä¢ Metals and Non-metals<br>
                        ‚Ä¢ Chemical Reactions<br><br>
                        Press <strong>1</strong> to ask about Acids & Bases<br>
                        Press <strong>2</strong> to ask about Metals<br>
                        Press <strong>9</strong> for direct question<br>
                        Press <strong>0</strong> to go back
                    </div>` :
                    `<div class="menu-text">
                        üß™ <strong>‡∞∞‡∞∏‡∞æ‡∞Ø‡∞® ‡∞∂‡∞æ‡∞∏‡±ç‡§§‡±ç‡∞∞ ‡∞µ‡∞ø‡∞∑‡∞Ø‡∞æ‡∞≤‡±Å</strong><br><br>
                        <strong>‡∞Ö‡∞Ç‡∞¶‡±Å‡∞¨‡∞æ‡∞ü‡±Å‡∞≤‡±ã ‡∞â‡∞®‡±ç‡∞® ‡∞µ‡∞ø‡∞∑‡∞Ø‡∞æ‡∞≤‡±Å:</strong><br>
                        ‚Ä¢ ‡∞Ü‡∞Æ‡±ç‡∞≤‡∞æ‡∞≤‡±Å, ‡∞ï‡±ç‡∞∑‡∞æ‡∞∞‡∞æ‡∞≤‡±Å ‡∞Æ‡∞∞‡∞ø‡∞Ø‡±Å ‡∞≤‡∞µ‡∞£‡∞æ‡∞≤‡±Å<br>
                        ‚Ä¢ ‡∞≤‡±ã‡∞π‡∞æ‡∞≤‡±Å ‡∞Æ‡∞∞‡∞ø‡∞Ø‡±Å ‡∞Ö‡∞≤‡±ã‡∞π‡∞æ‡∞≤‡±Å<br>
                        ‚Ä¢ ‡∞∞‡∞∏‡∞æ‡∞Ø‡∞® ‡∞ö‡∞∞‡±ç‡∞Ø‡∞≤‡±Å<br><br>
                        ‡∞Ü‡∞Æ‡±ç‡∞≤‡∞æ‡∞≤‡±Å & ‡∞ï‡±ç‡∞∑‡∞æ‡∞∞‡∞æ‡∞≤‡±Å ‡∞ó‡±Å‡∞∞‡∞ø‡∞Ç‡∞ö‡∞ø <strong>1</strong> ‡∞®‡±ä‡∞ï‡±ç‡∞ï‡∞Ç‡∞°‡∞ø<br>
                        ‡∞≤‡±ã‡∞π‡∞æ‡∞≤‡±Å ‡∞ó‡±Å‡∞∞‡∞ø‡∞Ç‡∞ö‡∞ø <strong>2</strong> ‡∞®‡±ä‡∞ï‡±ç‡∞ï‡∞Ç‡∞°‡∞ø<br>
                        ‡∞™‡±ç‡∞∞‡∞§‡±ç‡∞Ø‡∞ï‡±ç‡∞∑ ‡∞™‡±ç‡∞∞‡∞∂‡±ç‡∞® ‡∞ï‡±ã‡∞∏‡∞Ç <strong>9</strong> ‡∞®‡±ä‡∞ï‡±ç‡∞ï‡∞Ç‡∞°‡∞ø<br>
                        ‡∞µ‡±Ü‡∞®‡±Å‡∞ï‡∞ï‡±Å ‡∞µ‡±Ü‡∞≥‡±ç‡∞≤‡∞°‡∞æ‡∞®‡∞ø‡∞ï‡∞ø <strong>0</strong> ‡∞®‡±ä‡∞ï‡±ç‡∞ï‡∞Ç‡∞°‡∞ø
                    </div>`;

                updateScreenContent(message);

            } else if (key === '3') {
                // Biology topics
                const message = currentLanguage === 'english' ?
                    `<div class="menu-text">
                        üå± <strong>Biology Topics</strong><br><br>
                        <strong>Available Topics:</strong><br>
                        ‚Ä¢ Life Processes (Nutrition, Respiration)<br>
                        ‚Ä¢ Control and Coordination<br>
                        ‚Ä¢ Reproduction and Heredity<br><br>
                        Press <strong>1</strong> to ask about Life Processes<br>
                        Press <strong>2</strong> to ask about Control Systems<br>
                        Press <strong>9</strong> for direct question<br>
                        Press <strong>0</strong> to go back
                    </div>` :
                    `<div class="menu-text">
                        üå± <strong>‡∞ú‡±Ä‡∞µ ‡∞∂‡∞æ‡∞∏‡±ç‡∞§‡±ç‡∞∞ ‡∞µ‡∞ø‡∞∑‡∞Ø‡∞æ‡∞≤‡±Å</strong><br><br>
                        <strong>‡∞Ö‡∞Ç‡∞¶‡±Å‡∞¨‡∞æ‡∞ü‡±Å‡∞≤‡±ã ‡∞â‡∞®‡±ç‡∞® ‡∞µ‡∞ø‡∞∑‡∞Ø‡∞æ‡∞≤‡±Å:</strong><br>
                        ‚Ä¢ ‡∞ú‡±Ä‡∞µ ‡∞™‡±ç‡∞∞‡∞ï‡±ç‡∞∞‡∞ø‡∞Ø‡∞≤‡±Å (‡∞™‡±ã‡∞∑‡∞£, ‡∞∂‡±ç‡∞µ‡∞æ‡∞∏)<br>
                        ‚Ä¢ ‡∞®‡∞ø‡∞Ø‡∞Ç‡∞§‡±ç‡∞∞‡∞£ ‡∞Æ‡∞∞‡∞ø‡∞Ø‡±Å ‡∞∏‡∞Æ‡∞®‡±ç‡∞µ‡∞Ø‡∞Ç<br>
                        ‚Ä¢ ‡∞™‡±Å‡∞®‡∞∞‡±Å‡∞§‡±ç‡∞™‡∞§‡±ç‡∞§‡∞ø ‡∞Æ‡∞∞‡∞ø‡∞Ø‡±Å ‡∞µ‡∞Ç‡∞∂‡∞™‡∞æ‡∞∞‡∞Ç‡∞™‡∞∞‡±ç‡∞Ø‡∞§<br><br>
                        ‡∞ú‡±Ä‡∞µ ‡∞™‡±ç‡∞∞‡∞ï‡±ç‡∞∞‡∞ø‡∞Ø‡∞≤‡±Å ‡∞ó‡±Å‡∞∞‡∞ø‡∞Ç‡∞ö‡∞ø <strong>1</strong> ‡∞®‡±ä‡∞ï‡±ç‡∞ï‡∞Ç‡∞°‡∞ø<br>
                        ‡∞®‡∞ø‡∞Ø‡∞Ç‡∞§‡±ç‡∞∞‡∞£ ‡∞µ‡±ç‡∞Ø‡∞µ‡∞∏‡±ç‡∞•‡∞≤‡±Å ‡∞ó‡±Å‡∞∞‡∞ø‡∞Ç‡∞ö‡∞ø <strong>2</strong> ‡∞®‡±ä‡∞ï‡±ç‡∞ï‡∞Ç‡∞°‡∞ø<br>
                        ‡∞™‡±ç‡∞∞‡∞§‡±ç‡∞Ø‡∞ï‡±ç‡∞∑ ‡∞™‡±ç‡∞∞‡∞∂‡±ç‡∞® ‡∞ï‡±ã‡∞∏‡∞Ç <strong>9</strong> ‡∞®‡±ä‡∞ï‡±ç‡∞ï‡∞Ç‡∞°‡∞ø<br>
                        ‡∞µ‡±Ü‡∞®‡±Å‡∞ï‡∞ï‡±Å ‡∞µ‡±Ü‡∞≥‡±ç‡∞≤‡∞°‡∞æ‡∞®‡∞ø‡∞ï‡∞ø <strong>0</strong> ‡∞®‡±ä‡∞ï‡±ç‡∞ï‡∞Ç‡∞°‡∞ø
                    </div>`;

                updateScreenContent(message);

            } else if (key === '9') {
                // Switch to direct question mode
                const message = currentLanguage === 'english' ?
                    `<div class="menu-text">
                        üé§ <strong>Direct Question Mode</strong><br><br>
                        Please ask your Class 10 Science question clearly.<br><br>
                        You can use the demo questions below or speak your question.
                    </div>` :
                    `<div class="menu-text">
                        üé§ <strong>‡∞™‡±ç‡∞∞‡∞§‡±ç‡∞Ø‡∞ï‡±ç‡∞∑ ‡∞™‡±ç‡∞∞‡∞∂‡±ç‡∞® ‡∞Æ‡±ã‡∞°‡±ç</strong><br><br>
                        ‡∞¶‡∞Ø‡∞ö‡±á‡∞∏‡∞ø ‡∞Æ‡±Ä ‡∞ï‡±ç‡∞≤‡∞æ‡∞∏‡±ç 10 ‡∞∏‡±à‡∞®‡±ç‡∞∏‡±ç ‡∞™‡±ç‡∞∞‡∞∂‡±ç‡∞®‡∞®‡±Å ‡∞∏‡±ç‡∞™‡∞∑‡±ç‡∞ü‡∞Ç‡∞ó‡∞æ ‡∞Ö‡∞°‡∞ó‡∞Ç‡∞°‡∞ø.<br><br>
                        ‡∞Æ‡±Ä‡∞∞‡±Å ‡∞ï‡±ç‡∞∞‡∞ø‡∞Ç‡∞¶‡∞ø ‡∞°‡±Ü‡∞Æ‡±ã ‡∞™‡±ç‡∞∞‡∞∂‡±ç‡∞®‡∞≤‡∞®‡±Å ‡∞â‡∞™‡∞Ø‡±ã‡∞ó‡∞ø‡∞Ç‡∞ö‡∞µ‡∞ö‡±ç‡∞ö‡±Å ‡∞≤‡±á‡∞¶‡∞æ ‡∞Æ‡±Ä ‡∞™‡±ç‡∞∞‡∞∂‡±ç‡∞®‡∞®‡±Å ‡∞ö‡±Ü‡∞™‡±ç‡∞™‡∞µ‡∞ö‡±ç‡∞ö‡±Å.
                    </div>`;

                updateScreenContent(message);
                updateCallStatus('status-listening', 'Listening for Question');
                currentStep = 6; // Move to question recording

                // Show demo questions
                document.getElementById('demo-questions').style.display = 'block';

            } else if (key === '0') {
                // Go back to interaction mode
                const message = currentLanguage === 'english' ?
                    `<div class="menu-text">
                        üìö <strong>Class 10 Science Confirmed</strong><br><br>
                        How would you like to interact?<br><br>
                        Press <strong>1</strong> to browse topics<br>
                        Press <strong>2</strong> to ask a question directly
                    </div>` :
                    `<div class="menu-text">
                        üìö <strong>‡∞ï‡±ç‡∞≤‡∞æ‡∞∏‡±ç 10 ‡∞∏‡±à‡∞®‡±ç‡∞∏‡±ç ‡∞®‡∞ø‡∞∞‡±ç‡∞ß‡∞æ‡∞∞‡∞ø‡∞Ç‡∞ö‡∞¨‡∞°‡∞ø‡∞Ç‡∞¶‡∞ø</strong><br><br>
                        ‡∞Æ‡±Ä‡∞∞‡±Å ‡∞é‡∞≤‡∞æ ‡∞∏‡∞Ç‡∞≠‡∞æ‡∞∑‡∞ø‡∞Ç‡∞ö‡∞æ‡∞≤‡∞®‡±Å‡∞ï‡±Å‡∞Ç‡∞ü‡±Å‡∞®‡±ç‡∞®‡∞æ‡∞∞‡±Å?<br><br>
                        ‡∞µ‡∞ø‡∞∑‡∞Ø‡∞æ‡∞≤‡±Å ‡∞ö‡±Ç‡∞°‡∞ü‡∞æ‡∞®‡∞ø‡∞ï‡∞ø <strong>1</strong> ‡∞®‡±ä‡∞ï‡±ç‡∞ï‡∞Ç‡∞°‡∞ø<br>
                        ‡∞™‡±ç‡∞∞‡∞§‡±ç‡∞Ø‡∞ï‡±ç‡∞∑‡∞Ç‡∞ó‡∞æ ‡∞™‡±ç‡∞∞‡∞∂‡±ç‡∞® ‡∞Ö‡∞°‡∞ó‡∞°‡∞æ‡∞®‡∞ø‡∞ï‡∞ø <strong>2</strong> ‡∞®‡±ä‡∞ï‡±ç‡∞ï‡∞Ç‡∞°‡∞ø
                    </div>`;

                updateScreenContent(message);
                updateCallStatus('status-connected', 'Interaction Mode');
                currentStep = 4; // Back to interaction mode
            }
        }

        function handleFollowUp(key) {
            if (key === '1') {
                // Ask another question
                const message = currentLanguage === 'english' ?
                    `<div class="menu-text">
                        üé§ <strong>Ready for Next Question</strong><br><br>
                        Please ask your next Class 10 Science question.
                    </div>` :
                    `<div class="menu-text">
                        üé§ <strong>‡∞§‡∞¶‡±Å‡∞™‡∞∞‡∞ø ‡∞™‡±ç‡∞∞‡∞∂‡±ç‡∞®‡∞ï‡±Å ‡∞∏‡∞ø‡∞¶‡±ç‡∞ß‡∞Ç</strong><br><br>
                        ‡∞¶‡∞Ø‡∞ö‡±á‡∞∏‡∞ø ‡∞Æ‡±Ä ‡∞§‡∞¶‡±Å‡∞™‡∞∞‡∞ø ‡∞ï‡±ç‡∞≤‡∞æ‡∞∏‡±ç 10 ‡∞∏‡±à‡∞®‡±ç‡∞∏‡±ç ‡∞™‡±ç‡∞∞‡∞∂‡±ç‡∞®‡∞®‡±Å ‡∞Ö‡∞°‡∞ó‡∞Ç‡∞°‡∞ø.
                    </div>`;

                updateScreenContent(message);
                updateCallStatus('status-listening', 'Listening for Question');
                currentStep = 6; // Back to question recording
                document.getElementById('demo-questions').style.display = 'block';
                document.getElementById('response-display').style.display = 'none';

            } else if (key === '9') {
                // Main menu
                playWelcomeMessage();
            } else if (key === '0') {
                // End call
                endCall();
            }
        }

        async function askDemoQuestion(question) {
            if (!callActive || isProcessing) return;

            isProcessing = true;
            document.getElementById('demo-questions').style.display = 'none';

            // Show processing
            updateCallStatus('status-processing', 'AI Processing Question');
            updateFlowStep(7);

            updateScreenContent(`
                <div class="menu-text">
                    <strong>Question Received:</strong><br>
                    "${question}"<br><br>
                    ü§ñ AI is processing your question...
                </div>
            `);

            document.getElementById('processing-indicator').style.display = 'block';

            try {
                // Simulate processing time
                await sleep(2000);

                // Get cached response
                const response = await fetch('/api/demo/response', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ question: question })
                });

                const responseData = await response.json();

                if (responseData.response) {
                    currentResponse = responseData.response;
                    showResponse(question, responseData.response);
                } else {
                    showError("Sorry, I don't have information about that topic. Please try another question.");
                }

            } catch (error) {
                console.error('Error processing question:', error);
                showError("There was an error processing your question. Please try again.");
            }

            isProcessing = false;
            document.getElementById('processing-indicator').style.display = 'none';
        }

        function showResponse(question, response) {
            updateCallStatus('status-connected', 'Response Ready');
            updateFlowStep(8);

            updateScreenContent(`
                <div class="menu-text">
                    <strong>Q:</strong> ${question}<br><br>
                    <strong>ü§ñ VidyaVani AI Response:</strong><br>
                    ${response}
                </div>
            `);

            document.getElementById('response-text').textContent = response;
            document.getElementById('response-display').style.display = 'block';

            // Show follow-up menu after a delay
            setTimeout(() => {
                showFollowUpMenu();
            }, 3000);
        }

        function showFollowUpMenu() {
            updateFlowStep(9);

            const message = currentLanguage === 'english' ?
                `<div class="menu-text">
                    <strong>What would you like to do next?</strong><br><br>
                    Press <strong>1</strong> to ask another question<br>
                    Press <strong>9</strong> for main menu<br>
                    Press <strong>0</strong> to end call
                </div>` :
                `<div class="menu-text">
                    <strong>‡∞Æ‡±Ä‡∞∞‡±Å ‡∞§‡∞∞‡±ç‡∞µ‡∞æ‡∞§ ‡∞è‡∞Æ‡∞ø ‡∞ö‡±á‡∞Ø‡∞æ‡∞≤‡∞®‡±Å‡∞ï‡±Å‡∞Ç‡∞ü‡±Å‡∞®‡±ç‡∞®‡∞æ‡∞∞‡±Å?</strong><br><br>
                    ‡∞Æ‡∞∞‡±ã ‡∞™‡±ç‡∞∞‡∞∂‡±ç‡∞® ‡∞Ö‡∞°‡∞ó‡∞°‡∞æ‡∞®‡∞ø‡∞ï‡∞ø <strong>1</strong> ‡∞®‡±ä‡∞ï‡±ç‡∞ï‡∞Ç‡∞°‡∞ø<br>
                    ‡∞Æ‡±Ü‡∞Ø‡∞ø‡∞®‡±ç ‡∞Æ‡±Ü‡∞®‡±Ç‡∞ï‡∞ø <strong>9</strong> ‡∞®‡±ä‡∞ï‡±ç‡∞ï‡∞Ç‡∞°‡∞ø<br>
                    ‡∞ï‡∞æ‡∞≤‡±ç ‡∞Æ‡±Å‡∞ó‡∞ø‡∞Ç‡∞ö‡∞°‡∞æ‡∞®‡∞ø‡∞ï‡∞ø <strong>0</strong> ‡∞®‡±ä‡∞ï‡±ç‡∞ï‡∞Ç‡∞°‡∞ø
                </div>`;

            updateScreenContent(message);
        }

        function showError(message) {
            updateCallStatus('status-connected', 'Error Occurred');

            updateScreenContent(`
                <div class="menu-text" style="border-left-color: #f44336; background: rgba(244, 67, 54, 0.1);">
                    ‚ùå <strong>Error:</strong><br>
                    ${message}<br><br>
                    Press <strong>1</strong> to try again<br>
                    Press <strong>9</strong> for main menu
                </div>
            `);
        }

        function playResponse() {
            if (!currentResponse) return;

            // Use speech synthesis for demo
            const utterance = new SpeechSynthesisUtterance(currentResponse);
            utterance.rate = 0.9;
            utterance.pitch = 1.0;
            utterance.lang = currentLanguage === 'telugu' ? 'te-IN' : 'en-IN';

            speechSynthesis.speak(utterance);
        }

        function updateCallStatus(statusClass, statusText) {
            const indicator = document.getElementById('call-status-indicator');
            const text = document.getElementById('call-status-text');

            indicator.className = `status-indicator ${statusClass}`;
            text.textContent = statusText;
        }

        function updateScreenContent(content) {
            document.getElementById('screen-content').innerHTML = content;
        }

        function updateFlowStep(step) {
            currentStep = step;

            // Update flow step indicators
            document.querySelectorAll('.flow-step').forEach((el, index) => {
                el.classList.toggle('active', index === step);
            });
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // Voice Recording Functionality
        let mediaRecorder;
        let audioChunks = [];
        let isRecording = false;

        async function toggleRecording() {
            if (!isRecording) {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];

                    mediaRecorder.ondataavailable = event => {
                        audioChunks.push(event.data);
                    };

                    mediaRecorder.onstop = async () => {
                        const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                        await processVoiceQuestion(audioBlob);

                        // Stop all tracks to release microphone
                        stream.getTracks().forEach(track => track.stop());
                    };

                    mediaRecorder.start();
                    isRecording = true;

                    document.getElementById('record-btn').textContent = 'üõë Stop Recording';
                    document.getElementById('record-btn').style.background = 'rgba(76, 175, 80, 0.2)';
                    document.getElementById('record-btn').style.borderColor = '#4CAF50';
                    document.getElementById('recording-status').style.display = 'block';

                } catch (error) {
                    console.error('Error accessing microphone:', error);
                    alert('Could not access microphone. Please check permissions.');
                }
            } else {
                mediaRecorder.stop();
                isRecording = false;

                document.getElementById('record-btn').textContent = 'üé§ Click to Record Your Question';
                document.getElementById('record-btn').style.background = 'rgba(244, 67, 54, 0.2)';
                document.getElementById('record-btn').style.borderColor = '#f44336';
                document.getElementById('recording-status').style.display = 'none';
            }
        }

        async function processVoiceQuestion(audioBlob) {
            if (!callActive || isProcessing) return;

            isProcessing = true;
            document.getElementById('demo-questions').style.display = 'none';

            // Show processing
            updateCallStatus('status-processing', 'Processing Voice Question');
            updateFlowStep(7);

            updateScreenContent(`
                <div class="menu-text">
                    <strong>Voice Question Received</strong><br><br>
                    üé§ Converting speech to text...<br>
                    ü§ñ AI is processing your question...
                </div>
            `);

            document.getElementById('processing-indicator').style.display = 'block';

            try {
                // Simulate voice processing (in real system, this would use Google Cloud STT)
                await sleep(2000);

                // For demo, use a sample question
                const sampleQuestions = [
                    "What is reflection of light?",
                    "How does a concave mirror work?",
                    "What is the difference between AC and DC current?",
                    "Explain Ohm's law"
                ];

                const randomQuestion = sampleQuestions[Math.floor(Math.random() * sampleQuestions.length)];

                updateScreenContent(`
                    <div class="menu-text">
                        <strong>Speech Recognition Result:</strong><br>
                        "${randomQuestion}"<br><br>
                        ü§ñ AI is processing your question...
                    </div>
                `);

                await sleep(1000);

                // Get AI response
                const response = await fetch('/api/demo/response', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ question: randomQuestion })
                });

                const responseData = await response.json();

                if (responseData.response) {
                    currentResponse = responseData.response;
                    showResponse(randomQuestion, responseData.response);
                } else {
                    showError("Sorry, I don't have information about that topic. Please try another question.");
                }

            } catch (error) {
                console.error('Error processing voice question:', error);
                showError("There was an error processing your voice question. Please try again.");
            }

            isProcessing = false;
            document.getElementById('processing-indicator').style.display = 'none';
        }

        // Keyboard shortcuts for demo
        document.addEventListener('keydown', function (e) {
            if (e.key >= '0' && e.key <= '9') {
                pressKey(e.key);
            } else if (e.key === '*') {
                pressKey('*');
            } else if (e.key === '#') {
                pressKey('#');
            } else if (e.key === 'Enter' && !callActive) {
                startCall();
            } else if (e.key === 'Escape' && callActive) {
                endCall();
            }
        });
    </script>
</body>

</html>