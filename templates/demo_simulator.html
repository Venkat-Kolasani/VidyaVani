<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VidyaVani Phone Call Simulator</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .phone-container {
            background: #2c3e50;
            border-radius: 30px;
            padding: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            max-width: 400px;
            width: 100%;
            position: relative;
        }

        .phone-header {
            text-align: center;
            color: white;
            margin-bottom: 20px;
        }

        .phone-header h1 {
            margin: 0;
            font-size: 1.5em;
            font-weight: 300;
        }

        .phone-number {
            background: #34495e;
            color: #4CAF50;
            padding: 10px;
            border-radius: 10px;
            text-align: center;
            font-family: 'Courier New', monospace;
            font-size: 1.2em;
            margin-bottom: 20px;
            border: 2px solid #4CAF50;
        }

        .phone-screen {
            background: #1a252f;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            min-height: 200px;
            border: 3px solid #34495e;
            position: relative;
            overflow: hidden;
        }

        .screen-content {
            color: #ecf0f1;
            line-height: 1.6;
            font-size: 1.1em;
        }

        .call-status {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px;
            background: rgba(52, 73, 94, 0.5);
            border-radius: 8px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 10px;
            animation: pulse 2s infinite;
        }

        .status-connected {
            background-color: #4CAF50;
        }

        .status-processing {
            background-color: #FF9800;
        }

        .status-listening {
            background-color: #2196F3;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .menu-text {
            margin: 15px 0;
            padding: 15px;
            background: rgba(76, 175, 80, 0.1);
            border-left: 4px solid #4CAF50;
            border-radius: 5px;
        }

        .keypad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .key {
            background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%);
            border: 2px solid #4CAF50;
            color: white;
            padding: 20px;
            border-radius: 50%;
            font-size: 1.5em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 60px;
            position: relative;
        }

        .key:hover {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.4);
        }

        .key:active {
            transform: scale(0.95);
        }

        .key-letters {
            font-size: 0.6em;
            position: absolute;
            bottom: 8px;
            color: #bdc3c7;
        }

        .call-controls {
            display: flex;
            justify-content: space-around;
            margin-top: 20px;
        }

        .call-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .call-btn.start {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
        }

        .call-btn.end {
            background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
            color: white;
        }

        .call-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .demo-questions {
            margin-top: 20px;
            background: rgba(52, 73, 94, 0.3);
            border-radius: 10px;
            padding: 15px;
        }

        .demo-questions h3 {
            color: #4CAF50;
            margin: 0 0 15px 0;
            font-size: 1.1em;
        }

        .question-btn {
            display: block;
            width: 100%;
            background: rgba(33, 150, 243, 0.2);
            color: #ecf0f1;
            border: 1px solid #2196F3;
            padding: 8px 12px;
            margin: 5px 0;
            border-radius: 5px;
            cursor: pointer;
            text-align: left;
            font-size: 0.9em;
            transition: all 0.3s;
        }

        .question-btn:hover {
            background: rgba(33, 150, 243, 0.4);
            border-color: #4CAF50;
        }

        .processing-indicator {
            display: none;
            text-align: center;
            padding: 20px;
            color: #FF9800;
        }

        .processing-dots {
            display: inline-block;
            animation: dots 1.5s infinite;
        }

        @keyframes dots {

            0%,
            20% {
                content: '.';
            }

            40% {
                content: '..';
            }

            60%,
            100% {
                content: '...';
            }
        }

        .response-display {
            display: none;
            background: rgba(76, 175, 80, 0.1);
            border: 1px solid #4CAF50;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            color: #ecf0f1;
        }

        .audio-controls {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
        }

        .play-btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.9em;
        }

        .play-btn:hover {
            background: #45a049;
        }

        .call-flow-info {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px;
            border-radius: 10px;
            max-width: 300px;
            font-size: 0.9em;
        }

        .flow-step {
            margin: 8px 0;
            padding: 5px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .flow-step.active {
            color: #4CAF50;
            font-weight: bold;
        }

        @media (max-width: 768px) {
            .call-flow-info {
                position: relative;
                top: auto;
                right: auto;
                margin: 20px 0;
            }

            body {
                padding: 10px;
            }
        }

        .dtmf-feedback {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(76, 175, 80, 0.9);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 2em;
            font-weight: bold;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }

        .dtmf-feedback.show {
            opacity: 1;
        }

        /* Network Activity Styles */
        .network-entry {
            margin: 2px 0;
            padding: 2px 5px;
            border-radius: 3px;
            background: rgba(76, 175, 80, 0.1);
            border-left: 2px solid #4CAF50;
            font-family: 'Courier New', monospace;
        }

        .timestamp {
            color: #4CAF50;
            font-weight: bold;
        }

        .metric-item {
            margin: 5px 0;
            padding: 3px 8px;
            background: rgba(33, 150, 243, 0.1);
            border-radius: 3px;
            border-left: 2px solid #2196F3;
        }

        .system-online {
            background: rgba(76, 175, 80, 0.2) !important;
            color: #4CAF50 !important;
            border: 1px solid #4CAF50 !important;
        }

        .system-offline {
            background: rgba(244, 67, 54, 0.2) !important;
            color: #f44336 !important;
            border: 1px solid #f44336 !important;
        }

        /* Enhanced call flow info for better visibility */
        .call-flow-info {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 15px;
            border-radius: 10px;
            max-width: 350px;
            font-size: 0.9em;
            border: 2px solid #4CAF50;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .call-flow-info h3, .call-flow-info h4 {
            margin: 0 0 10px 0;
            color: #4CAF50;
        }
    </style>
</head>

<body>
    <!-- Call Flow Information Panel -->
    <div class="call-flow-info">
        <h3>üìû IVR Call Flow</h3>
        <div class="flow-step" id="step-1">1. Dial VidyaVani Number</div>
        <div class="flow-step" id="step-2">2. Welcome Message</div>
        <div class="flow-step" id="step-3">3. Language Selection (1/2)</div>
        <div class="flow-step" id="step-4">4. Grade Confirmation</div>
        <div class="flow-step" id="step-5">5. Interaction Mode</div>
        <div class="flow-step" id="step-6">6. Ask Question</div>
        <div class="flow-step" id="step-7">7. AI Processing</div>
        <div class="flow-step" id="step-8">8. Response Delivery</div>
        <div class="flow-step" id="step-9">9. Follow-up Menu</div>
        
        <!-- Network Activity Monitor -->
        <div style="margin-top: 20px; border-top: 1px solid rgba(255,255,255,0.2); padding-top: 15px;">
            <h4>üåê Network Activity</h4>
            <div id="network-log" style="max-height: 150px; overflow-y: auto; font-size: 0.8em; background: rgba(0,0,0,0.3); padding: 8px; border-radius: 5px;">
                <div class="network-entry">System ready...</div>
            </div>
        </div>
        
        <!-- Performance Metrics -->
        <div style="margin-top: 15px; border-top: 1px solid rgba(255,255,255,0.2); padding-top: 15px;">
            <h4>üìä Live Metrics</h4>
            <div id="performance-display" style="font-size: 0.8em;">
                <div class="metric-item">ü§ñ AI Requests: 0</div>
                <div class="metric-item">üé§ STT Requests: 0</div>
                <div class="metric-item">üìû Session: None</div>
            </div>
        </div>
    </div>

    <div class="phone-container">
        <div class="phone-header">
            <h1>üì± VidyaVani IVR Simulator</h1>
        </div>

        <div class="phone-number">
            üìû +91-XXXX-VIDYA (84392)
        </div>

        <div class="phone-screen">
            <div class="call-status">
                <div class="status-indicator status-connected" id="call-status-indicator"></div>
                <span id="call-status-text">Ready to Call</span>
            </div>

            <div class="screen-content" id="screen-content">
                <div class="menu-text">
                    <strong>Welcome to VidyaVani!</strong><br>
                    Your AI-powered learning assistant for Class 10 Science.<br><br>
                    Press the <strong>üìû CALL</strong> button to start your learning session.
                </div>
            </div>

            <div class="processing-indicator" id="processing-indicator">
                <div>ü§ñ AI Processing your question</div>
                <div class="processing-dots">...</div>
            </div>

            <div class="response-display" id="response-display">
                <div id="response-text"></div>
                <div class="audio-controls">
                    <button class="play-btn" onclick="playResponse()">
                        üîä Play Response
                    </button>
                </div>
            </div>

            <!-- DTMF Feedback -->
            <div class="dtmf-feedback" id="dtmf-feedback"></div>
        </div>

        <!-- Phone Keypad -->
        <div class="keypad">
            <div class="key" onclick="pressKey('1')">
                1
                <div class="key-letters"></div>
            </div>
            <div class="key" onclick="pressKey('2')">
                2
                <div class="key-letters">ABC</div>
            </div>
            <div class="key" onclick="pressKey('3')">
                3
                <div class="key-letters">DEF</div>
            </div>
            <div class="key" onclick="pressKey('4')">
                4
                <div class="key-letters">GHI</div>
            </div>
            <div class="key" onclick="pressKey('5')">
                5
                <div class="key-letters">JKL</div>
            </div>
            <div class="key" onclick="pressKey('6')">
                6
                <div class="key-letters">MNO</div>
            </div>
            <div class="key" onclick="pressKey('7')">
                7
                <div class="key-letters">PQRS</div>
            </div>
            <div class="key" onclick="pressKey('8')">
                8
                <div class="key-letters">TUV</div>
            </div>
            <div class="key" onclick="pressKey('9')">
                9
                <div class="key-letters">WXYZ</div>
            </div>
            <div class="key" onclick="pressKey('*')">
                *
            </div>
            <div class="key" onclick="pressKey('0')">
                0
                <div class="key-letters">+</div>
            </div>
            <div class="key" onclick="pressKey('#')">
                #
            </div>
        </div>

        <!-- Call Control Buttons -->
        <div class="call-controls">
            <button class="call-btn start" onclick="startCall()" id="start-call-btn">
                üìû
            </button>
            <button class="call-btn end" onclick="endCall()" id="end-call-btn" style="display: none;">
                üìµ
            </button>
        </div>

        <!-- Demo Questions (shown during question recording phase) -->
        <div class="demo-questions" id="demo-questions" style="display: none;">
            <h3>üéØ Quick Demo Questions</h3>

            <!-- Voice Recording Option -->
            <div class="voice-recording"
                style="margin-bottom: 15px; padding: 10px; background: rgba(76, 175, 80, 0.1); border-radius: 8px;">
                <button id="record-btn" class="question-btn" onclick="toggleRecording()"
                    style="background: rgba(244, 67, 54, 0.2); border-color: #f44336;">
                    üé§ Click to Record Your Question
                </button>
                <div id="recording-status" style="display: none; color: #f44336; margin-top: 5px; font-size: 0.9em;">
                    üî¥ Recording... Click again to stop
                </div>
            </div>

            <div id="question-list">
                <!-- Questions will be loaded here -->
            </div>
        </div>
    </div>

    <script>
        let callActive = false;
        let currentStep = 0;
        let currentLanguage = 'english';
        let isProcessing = false;
        let currentResponse = null;

        // IVR Flow Steps
        const flowSteps = [
            'idle',
            'welcome',
            'language_selection',
            'grade_confirmation',
            'interaction_mode',
            'topic_browsing',
            'question_recording',
            'processing',
            'response_delivery',
            'follow_up'
        ];

        // Backend API Configuration
        const API_BASE = 'https://vidyavani.onrender.com';
        let sessionId = null;
        let phoneNumber = '+91' + Math.floor(Math.random() * 9000000000 + 1000000000); // Generate demo phone number

        // Initialize
        document.addEventListener('DOMContentLoaded', function () {
            initializeSystem();
            loadDemoQuestions();
            updateFlowStep(0);
            showSystemStatus();
        });

        async function initializeSystem() {
            try {
                // Check system health
                const healthResponse = await fetch(`${API_BASE}/health`);
                const healthData = await healthResponse.json();
                console.log('System Health:', healthData);
                
                // Show system status in UI
                updateSystemStatus(healthData.status === 'healthy' ? 'online' : 'offline');
            } catch (error) {
                console.error('System initialization failed:', error);
                updateSystemStatus('offline');
            }
        }

        function updateSystemStatus(status) {
            const statusElement = document.getElementById('system-status');
            if (statusElement) {
                statusElement.textContent = status === 'online' ? 'üü¢ System Online' : 'üî¥ System Offline';
                statusElement.className = status === 'online' ? 'system-online' : 'system-offline';
            }
        }

        function showSystemStatus() {
            // Add system status indicator to the UI
            const header = document.querySelector('.phone-header');
            if (header && !document.getElementById('system-status')) {
                const statusDiv = document.createElement('div');
                statusDiv.id = 'system-status';
                statusDiv.style.cssText = 'margin: 10px 0; padding: 5px 10px; border-radius: 5px; font-size: 0.9em;';
                statusDiv.textContent = 'üîÑ Checking System...';
                header.appendChild(statusDiv);
            }
        }

        async function loadDemoQuestions() {
            try {
                console.log('üîÑ Loading demo questions from backend...');
                const response = await fetch(`${API_BASE}/api/demo/questions`);
                const data = await response.json();
                console.log('‚úÖ Demo questions loaded:', data);

                const questionList = document.getElementById('question-list');
                questionList.innerHTML = '';

                // Show first 8 questions for demo
                data.demo_questions.slice(0, 8).forEach((question, index) => {
                    const btn = document.createElement('button');
                    btn.className = 'question-btn';
                    btn.textContent = `${index + 1}. ${question}`;
                    btn.onclick = () => askDemoQuestion(question);
                    questionList.appendChild(btn);
                });

                // Add network activity indicator
                showNetworkActivity('Loaded ' + data.count + ' demo questions');

            } catch (error) {
                console.error('‚ùå Failed to load demo questions:', error);
                showNetworkActivity('Failed to load questions: ' + error.message);
            }
        }

        async function startCall() {
            if (callActive) return;

            try {
                console.log('üìû Starting call simulation...');
                
                // Create session with backend
                const sessionResponse = await fetch(`${API_BASE}/api/session/create`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        phone_number: phoneNumber,
                        source: 'demo_simulator'
                    })
                });
                
                if (sessionResponse.ok) {
                    const sessionData = await sessionResponse.json();
                    sessionId = sessionData.session_id;
                    console.log('‚úÖ Session created:', sessionData);
                    showNetworkActivity('Session created: ' + sessionId);
                } else {
                    console.warn('‚ö†Ô∏è Session creation failed, continuing with demo');
                    sessionId = 'demo_' + Date.now();
                }

                // Simulate webhook call to backend
                const webhookResponse = await fetch(`${API_BASE}/webhook/incoming-call`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams({
                        'From': phoneNumber,
                        'To': '+918012345678',
                        'CallSid': sessionId,
                        'CallStatus': 'in-progress'
                    })
                });

                if (webhookResponse.ok) {
                    const xmlResponse = await webhookResponse.text();
                    console.log('‚úÖ Webhook response:', xmlResponse);
                    showNetworkActivity('IVR webhook called successfully');
                }

                callActive = true;
                document.getElementById('start-call-btn').style.display = 'none';
                document.getElementById('end-call-btn').style.display = 'block';

                updateCallStatus('status-connected', 'Call Connected');
                updateFlowStep(1);

                // Simulate call connection delay
                setTimeout(() => {
                    playWelcomeMessage();
                }, 1000);

            } catch (error) {
                console.error('‚ùå Call start failed:', error);
                showNetworkActivity('Call failed: ' + error.message);
            }
        }

        function endCall() {
            if (!callActive) return;

            callActive = false;
            currentStep = 0;
            isProcessing = false;

            document.getElementById('start-call-btn').style.display = 'block';
            document.getElementById('end-call-btn').style.display = 'none';
            document.getElementById('demo-questions').style.display = 'none';
            document.getElementById('response-display').style.display = 'none';
            document.getElementById('processing-indicator').style.display = 'none';

            updateCallStatus('status-connected', 'Call Ended');
            updateFlowStep(0);

            setTimeout(() => {
                updateCallStatus('status-connected', 'Ready to Call');
                updateScreenContent(`
                    <div class="menu-text">
                        <strong>Welcome to VidyaVani!</strong><br>
                        Your AI-powered learning assistant for Class 10 Science.<br><br>
                        Press the <strong>üìû CALL</strong> button to start your learning session.
                    </div>
                `);
            }, 2000);
        }

        function playWelcomeMessage() {
            updateScreenContent(`
                <div class="menu-text">
                    üéµ <strong>Welcome to VidyaVani!</strong><br><br>
                    Your AI-powered learning assistant for Class 10 Science.<br><br>
                    Press <strong>1</strong> for English<br>
                    Press <strong>2</strong> for Telugu
                </div>
            `);
            updateFlowStep(2);
        }

        function pressKey(key) {
            if (!callActive) return;

            // Show DTMF feedback
            showDTMFFeedback(key);

            // Handle based on current step
            switch (flowSteps[currentStep]) {
                case 'language_selection':
                    handleLanguageSelection(key);
                    break;
                case 'grade_confirmation':
                    handleGradeConfirmation(key);
                    break;
                case 'interaction_mode':
                    handleInteractionMode(key);
                    break;
                case 'follow_up':
                    handleFollowUp(key);
                    break;
                case 'topic_browsing':
                    handleTopicBrowsing(key);
                    break;
                default:
                    if (currentStep === 1) {
                        // Still in welcome, treat as language selection
                        handleLanguageSelection(key);
                    }
            }
        }

        function showDTMFFeedback(key) {
            const feedback = document.getElementById('dtmf-feedback');
            feedback.textContent = key;
            feedback.classList.add('show');

            setTimeout(() => {
                feedback.classList.remove('show');
            }, 500);
        }

        async function handleLanguageSelection(key) {
            try {
                // Call backend webhook for language selection
                const webhookResponse = await fetch(`${API_BASE}/webhook/language-selection`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams({
                        'From': phoneNumber,
                        'CallSid': sessionId,
                        'Digits': key
                    })
                });

                if (webhookResponse.ok) {
                    const xmlResponse = await webhookResponse.text();
                    console.log('‚úÖ Language selection webhook response:', xmlResponse);
                    showNetworkActivity('Language selected: ' + (key === '1' ? 'English' : 'Telugu'));
                }

                // Update session language in backend
                if (sessionId) {
                    await fetch(`${API_BASE}/api/session/${encodeURIComponent(phoneNumber)}/language`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            language: key === '1' ? 'english' : 'telugu' 
                        })
                    });
                }

                if (key === '1') {
                    currentLanguage = 'english';
                    updateScreenContent(`
                        <div class="menu-text">
                            ‚úÖ <strong>English Selected</strong><br><br>
                            You are calling for <strong>Class 10 Science</strong> learning assistance.<br><br>
                            Press <strong>1</strong> to confirm<br>
                            Press <strong>2</strong> to change grade
                        </div>
                    `);
                    updateFlowStep(3);
                } else if (key === '2') {
                    currentLanguage = 'telugu';
                    updateScreenContent(`
                        <div class="menu-text">
                            ‚úÖ <strong>Telugu Selected</strong><br><br>
                            ‡∞Æ‡±Ä‡∞∞‡±Å <strong>‡∞ï‡±ç‡∞≤‡∞æ‡∞∏‡±ç 10 ‡∞∏‡±à‡∞®‡±ç‡∞∏‡±ç</strong> ‡∞∏‡∞π‡∞æ‡∞Ø‡∞Ç ‡∞ï‡±ã‡∞∏‡∞Ç ‡∞ï‡∞æ‡∞≤‡±ç ‡∞ö‡±á‡∞∏‡±ç‡∞§‡±Å‡∞®‡±ç‡∞®‡∞æ‡∞∞‡±Å.<br><br>
                            ‡∞®‡∞ø‡∞∞‡±ç‡∞ß‡∞æ‡∞∞‡∞ø‡∞Ç‡∞ö‡∞°‡∞æ‡∞®‡∞ø‡∞ï‡∞ø <strong>1</strong> ‡∞®‡±ä‡∞ï‡±ç‡∞ï‡∞Ç‡∞°‡∞ø<br>
                            ‡∞ó‡±ç‡∞∞‡±á‡∞°‡±ç ‡∞Æ‡∞æ‡∞∞‡±ç‡∞ö‡∞°‡∞æ‡∞®‡∞ø‡∞ï‡∞ø <strong>2</strong> ‡∞®‡±ä‡∞ï‡±ç‡∞ï‡∞Ç‡∞°‡∞ø
                        </div>
                    `);
                    updateFlowStep(3);
                }
            } catch (error) {
                console.error('‚ùå Language selection failed:', error);
                showNetworkActivity('Language selection error: ' + error.message);
            }
        }

        function handleGradeConfirmation(key) {
            if (key === '1') {
                const message = currentLanguage === 'english' ?
                    `<div class="menu-text">
                        üìö <strong>Class 10 Science Confirmed</strong><br><br>
                        How would you like to interact?<br><br>
                        Press <strong>1</strong> to browse topics<br>
                        Press <strong>2</strong> to ask a question directly
                    </div>` :
                    `<div class="menu-text">
                        üìö <strong>‡∞ï‡±ç‡∞≤‡∞æ‡∞∏‡±ç 10 ‡∞∏‡±à‡∞®‡±ç‡∞∏‡±ç ‡∞®‡∞ø‡∞∞‡±ç‡∞ß‡∞æ‡∞∞‡∞ø‡∞Ç‡∞ö‡∞¨‡∞°‡∞ø‡∞Ç‡∞¶‡∞ø</strong><br><br>
                        ‡∞Æ‡±Ä‡∞∞‡±Å ‡∞é‡∞≤‡∞æ ‡∞∏‡∞Ç‡∞≠‡∞æ‡∞∑‡∞ø‡∞Ç‡∞ö‡∞æ‡∞≤‡∞®‡±Å‡∞ï‡±Å‡∞Ç‡∞ü‡±Å‡∞®‡±ç‡∞®‡∞æ‡∞∞‡±Å?<br><br>
                        ‡∞µ‡∞ø‡§∑‡∞Ø‡∞æ‡∞≤‡±Å ‡∞ö‡±Ç‡∞°‡∞ü‡∞æ‡∞®‡∞ø‡∞ï‡∞ø <strong>1</strong> ‡∞®‡±ä‡∞ï‡±ç‡∞ï‡∞Ç‡∞°‡∞ø<br>
                        ‡∞™‡±ç‡∞∞‡∞§‡±ç‡∞Ø‡∞ï‡±ç‡∞∑‡∞Ç‡∞ó‡∞æ ‡∞™‡±ç‡∞∞‡∞∂‡±ç‡∞® ‡∞Ö‡∞°‡∞ó‡∞°‡∞æ‡∞®‡∞ø‡∞ï‡∞ø <strong>2</strong> ‡∞®‡±ä‡∞ï‡±ç‡∞ï‡∞Ç‡∞°‡∞ø
                    </div>`;

                updateScreenContent(message);
                updateFlowStep(4);
            }
        }

        function handleInteractionMode(key) {
            if (key === '1') {
                // Browse topics mode
                const message = currentLanguage === 'english' ?
                    `<div class="menu-text">
                        üìö <strong>Browse Topics Selected</strong><br><br>
                        <strong>Class 10 Science Topics:</strong><br><br>
                        Press <strong>1</strong> for Physics (Light, Electricity)<br>
                        Press <strong>2</strong> for Chemistry (Acids, Bases, Metals)<br>
                        Press <strong>3</strong> for Biology (Life Processes)<br>
                        Press <strong>9</strong> to ask a direct question<br>
                        Press <strong>0</strong> for main menu
                    </div>` :
                    `<div class="menu-text">
                        üìö <strong>‡∞µ‡∞ø‡∞∑‡∞Ø‡∞æ‡∞≤‡±Å ‡∞ö‡±Ç‡∞°‡∞ü‡∞Ç ‡∞é‡∞Ç‡∞ö‡±Å‡∞ï‡±ã‡∞¨‡∞°‡∞ø‡∞Ç‡∞¶‡∞ø</strong><br><br>
                        <strong>‡∞ï‡±ç‡∞≤‡∞æ‡∞∏‡±ç 10 ‡∞∏‡±à‡∞®‡±ç‡∞∏‡±ç ‡∞µ‡∞ø‡∞∑‡∞Ø‡∞æ‡∞≤‡±Å:</strong><br><br>
                        ‡∞≠‡±å‡∞§‡∞ø‡∞ï ‡∞∂‡∞æ‡∞∏‡±ç‡∞§‡±ç‡∞∞‡∞Ç ‡∞ï‡±ã‡∞∏‡∞Ç <strong>1</strong> ‡∞®‡±ä‡∞ï‡±ç‡∞ï‡∞Ç‡∞°‡∞ø<br>
                        ‡∞∞‡∞∏‡∞æ‡∞Ø‡∞® ‡∞∂‡∞æ‡∞∏‡±ç‡∞§‡±ç‡∞∞‡∞Ç ‡∞ï‡±ã‡∞∏‡∞Ç <strong>2</strong> ‡∞®‡±ä‡∞ï‡±ç‡∞ï‡∞Ç‡∞°‡∞ø<br>
                        ‡∞ú‡±Ä‡∞µ ‡∞∂‡∞æ‡∞∏‡±ç‡∞§‡±ç‡∞∞‡∞Ç ‡∞ï‡±ã‡∞∏‡∞Ç <strong>3</strong> ‡∞®‡±ä‡∞ï‡±ç‡∞ï‡∞Ç‡∞°‡∞ø<br>
                        ‡∞™‡±ç‡∞∞‡∞§‡±ç‡∞Ø‡∞ï‡±ç‡∞∑ ‡∞™‡±ç‡∞∞‡∞∂‡±ç‡∞® ‡∞ï‡±ã‡∞∏‡∞Ç <strong>9</strong> ‡∞®‡±ä‡∞ï‡±ç‡∞ï‡∞Ç‡∞°‡∞ø<br>
                        ‡∞Æ‡±Ü‡∞Ø‡∞ø‡∞®‡±ç ‡∞Æ‡±Ü‡∞®‡±Ç ‡∞ï‡±ã‡∞∏‡∞Ç <strong>0</strong> ‡∞®‡±ä‡∞ï‡±ç‡∞ï‡∞Ç‡∞°‡∞ø
                    </div>`;

                updateScreenContent(message);
                updateCallStatus('status-connected', 'Browsing Topics');
                currentStep = 5; // Set to topic browsing step

            } else if (key === '2') {
                const message = currentLanguage === 'english' ?
                    `<div class="menu-text">
                        üé§ <strong>Question Mode Selected</strong><br><br>
                        Please ask your Class 10 Science question clearly.<br><br>
                        You can use the demo questions below or speak your question.
                    </div>` :
                    `<div class="menu-text">
                        üé§ <strong>‡∞™‡±ç‡∞∞‡∞∂‡±ç‡∞® ‡∞Æ‡±ã‡∞°‡±ç ‡∞é‡∞Ç‡∞ö‡±Å‡∞ï‡±ã‡∞¨‡∞°‡∞ø‡∞Ç‡∞¶‡∞ø</strong><br><br>
                        ‡∞¶‡∞Ø‡∞ö‡±á‡∞∏‡∞ø ‡∞Æ‡±Ä ‡∞ï‡±ç‡∞≤‡∞æ‡∞∏‡±ç 10 ‡∞∏‡±à‡∞®‡±ç‡∞∏‡±ç ‡∞™‡±ç‡∞∞‡∞∂‡±ç‡∞®‡∞®‡±Å ‡∞∏‡±ç‡∞™‡∞∑‡±ç‡∞ü‡∞Ç‡∞ó‡∞æ ‡∞Ö‡∞°‡∞ó‡∞Ç‡∞°‡∞ø.<br><br>
                        ‡∞Æ‡±Ä‡∞∞‡±Å ‡∞ï‡±ç‡∞∞‡∞ø‡∞Ç‡∞¶‡∞ø ‡∞°‡±Ü‡∞Æ‡±ã ‡∞™‡±ç‡∞∞‡∞∂‡±ç‡∞®‡∞≤‡∞®‡±Å ‡∞â‡∞™‡∞Ø‡±ã‡∞ó‡∞ø‡∞Ç‡∞ö‡∞µ‡∞ö‡±ç‡∞ö‡±Å ‡∞≤‡±á‡∞¶‡∞æ ‡∞Æ‡±Ä ‡∞™‡±ç‡∞∞‡∞∂‡±ç‡∞®‡∞®‡±Å ‡∞ö‡±Ü‡∞™‡±ç‡∞™‡∞µ‡∞ö‡±ç‡∞ö‡±Å.
                    </div>`;

                updateScreenContent(message);
                updateCallStatus('status-listening', 'Listening for Question');
                currentStep = 6; // Move to question recording step

                // Show demo questions
                document.getElementById('demo-questions').style.display = 'block';
            }
        }

        function handleTopicBrowsing(key) {
            if (key === '1') {
                // Physics topics
                const message = currentLanguage === 'english' ?
                    `<div class="menu-text">
                        ‚ö° <strong>Physics Topics</strong><br><br>
                        <strong>Available Topics:</strong><br>
                        ‚Ä¢ Light - Reflection and Refraction<br>
                        ‚Ä¢ Electricity and Magnetism<br>
                        ‚Ä¢ Current and Circuits<br><br>
                        Press <strong>1</strong> to ask about Light<br>
                        Press <strong>2</strong> to ask about Electricity<br>
                        Press <strong>9</strong> for direct question<br>
                        Press <strong>0</strong> to go back
                    </div>` :
                    `<div class="menu-text">
                        ‚ö° <strong>‡∞≠‡±å‡∞§‡∞ø‡∞ï ‡∞∂‡∞æ‡∞∏‡±ç‡∞§‡±ç‡∞∞ ‡∞µ‡∞ø‡∞∑‡∞Ø‡∞æ‡∞≤‡±Å</strong><br><br>
                        <strong>‡∞Ö‡∞Ç‡∞¶‡±Å‡∞¨‡∞æ‡∞ü‡±Å‡∞≤‡±ã ‡∞â‡∞®‡±ç‡∞® ‡∞µ‡∞ø‡∞∑‡∞Ø‡∞æ‡∞≤‡±Å:</strong><br>
                        ‚Ä¢ ‡∞ï‡∞æ‡∞Ç‡∞§‡∞ø - ‡∞™‡±ç‡∞∞‡∞§‡∞ø‡∞¨‡∞ø‡∞Ç‡∞¨‡∞Ç ‡∞Æ‡∞∞‡∞ø‡∞Ø‡±Å ‡∞µ‡∞ï‡±ç‡∞∞‡±Ä‡∞≠‡∞µ‡∞®‡∞Ç<br>
                        ‚Ä¢ ‡∞µ‡∞ø‡∞¶‡±ç‡∞Ø‡±Å‡∞§‡±ç ‡∞Æ‡∞∞‡∞ø‡∞Ø‡±Å ‡∞Ö‡∞Ø‡∞∏‡±ç‡∞ï‡∞æ‡∞Ç‡∞§‡∞§‡±ç‡∞µ‡∞Ç<br>
                        ‚Ä¢ ‡∞ï‡∞∞‡±Ü‡∞Ç‡∞ü‡±ç ‡∞Æ‡∞∞‡∞ø‡∞Ø‡±Å ‡∞∏‡∞∞‡±ç‡∞ï‡±ç‡∞Ø‡±Ç‡∞ü‡±ç‡∞≤‡±Å<br><br>
                        ‡∞ï‡∞æ‡∞Ç‡∞§‡∞ø ‡∞ó‡±Å‡∞∞‡∞ø‡∞Ç‡∞ö‡∞ø ‡∞Ö‡∞°‡∞ó‡∞°‡∞æ‡∞®‡∞ø‡∞ï‡∞ø <strong>1</strong> ‡∞®‡±ä‡∞ï‡±ç‡∞ï‡∞Ç‡∞°‡∞ø<br>
                        ‡∞µ‡∞ø‡∞¶‡±ç‡∞Ø‡±Å‡∞§‡±ç ‡∞ó‡±Å‡∞∞‡∞ø‡∞Ç‡∞ö‡∞ø ‡∞Ö‡∞°‡∞ó‡∞°‡∞æ‡∞®‡∞ø‡∞ï‡∞ø <strong>2</strong> ‡∞®‡±ä‡∞ï‡±ç‡∞ï‡∞Ç‡∞°‡∞ø<br>
                        ‡∞™‡±ç‡∞∞‡∞§‡±ç‡∞Ø‡∞ï‡±ç‡∞∑ ‡∞™‡±ç‡∞∞‡∞∂‡±ç‡∞® ‡∞ï‡±ã‡∞∏‡∞Ç <strong>9</strong> ‡∞®‡±ä‡∞ï‡±ç‡∞ï‡∞Ç‡∞°‡∞ø<br>
                        ‡∞µ‡±Ü‡∞®‡±Å‡∞ï‡∞ï‡±Å ‡∞µ‡±Ü‡∞≥‡±ç‡∞≤‡∞°‡∞æ‡∞®‡∞ø‡∞ï‡∞ø <strong>0</strong> ‡∞®‡±ä‡∞ï‡±ç‡∞ï‡∞Ç‡∞°‡∞ø
                    </div>`;

                updateScreenContent(message);

            } else if (key === '2') {
                // Chemistry topics
                const message = currentLanguage === 'english' ?
                    `<div class="menu-text">
                        üß™ <strong>Chemistry Topics</strong><br><br>
                        <strong>Available Topics:</strong><br>
                        ‚Ä¢ Acids, Bases and Salts<br>
                        ‚Ä¢ Metals and Non-metals<br>
                        ‚Ä¢ Chemical Reactions<br><br>
                        Press <strong>1</strong> to ask about Acids & Bases<br>
                        Press <strong>2</strong> to ask about Metals<br>
                        Press <strong>9</strong> for direct question<br>
                        Press <strong>0</strong> to go back
                    </div>` :
                    `<div class="menu-text">
                        üß™ <strong>‡∞∞‡∞∏‡∞æ‡∞Ø‡∞® ‡∞∂‡∞æ‡∞∏‡±ç‡§§‡±ç‡∞∞ ‡∞µ‡∞ø‡∞∑‡∞Ø‡∞æ‡∞≤‡±Å</strong><br><br>
                        <strong>‡∞Ö‡∞Ç‡∞¶‡±Å‡∞¨‡∞æ‡∞ü‡±Å‡∞≤‡±ã ‡∞â‡∞®‡±ç‡∞® ‡∞µ‡∞ø‡∞∑‡∞Ø‡∞æ‡∞≤‡±Å:</strong><br>
                        ‚Ä¢ ‡∞Ü‡∞Æ‡±ç‡∞≤‡∞æ‡∞≤‡±Å, ‡∞ï‡±ç‡∞∑‡∞æ‡∞∞‡∞æ‡∞≤‡±Å ‡∞Æ‡∞∞‡∞ø‡∞Ø‡±Å ‡∞≤‡∞µ‡∞£‡∞æ‡∞≤‡±Å<br>
                        ‚Ä¢ ‡∞≤‡±ã‡∞π‡∞æ‡∞≤‡±Å ‡∞Æ‡∞∞‡∞ø‡∞Ø‡±Å ‡∞Ö‡∞≤‡±ã‡∞π‡∞æ‡∞≤‡±Å<br>
                        ‚Ä¢ ‡∞∞‡∞∏‡∞æ‡∞Ø‡∞® ‡∞ö‡∞∞‡±ç‡∞Ø‡∞≤‡±Å<br><br>
                        ‡∞Ü‡∞Æ‡±ç‡∞≤‡∞æ‡∞≤‡±Å & ‡∞ï‡±ç‡∞∑‡∞æ‡∞∞‡∞æ‡∞≤‡±Å ‡∞ó‡±Å‡∞∞‡∞ø‡∞Ç‡∞ö‡∞ø <strong>1</strong> ‡∞®‡±ä‡∞ï‡±ç‡∞ï‡∞Ç‡∞°‡∞ø<br>
                        ‡∞≤‡±ã‡∞π‡∞æ‡∞≤‡±Å ‡∞ó‡±Å‡∞∞‡∞ø‡∞Ç‡∞ö‡∞ø <strong>2</strong> ‡∞®‡±ä‡∞ï‡±ç‡∞ï‡∞Ç‡∞°‡∞ø<br>
                        ‡∞™‡±ç‡∞∞‡∞§‡±ç‡∞Ø‡∞ï‡±ç‡∞∑ ‡∞™‡±ç‡∞∞‡∞∂‡±ç‡∞® ‡∞ï‡±ã‡∞∏‡∞Ç <strong>9</strong> ‡∞®‡±ä‡∞ï‡±ç‡∞ï‡∞Ç‡∞°‡∞ø<br>
                        ‡∞µ‡±Ü‡∞®‡±Å‡∞ï‡∞ï‡±Å ‡∞µ‡±Ü‡∞≥‡±ç‡∞≤‡∞°‡∞æ‡∞®‡∞ø‡∞ï‡∞ø <strong>0</strong> ‡∞®‡±ä‡∞ï‡±ç‡∞ï‡∞Ç‡∞°‡∞ø
                    </div>`;

                updateScreenContent(message);

            } else if (key === '3') {
                // Biology topics
                const message = currentLanguage === 'english' ?
                    `<div class="menu-text">
                        üå± <strong>Biology Topics</strong><br><br>
                        <strong>Available Topics:</strong><br>
                        ‚Ä¢ Life Processes (Nutrition, Respiration)<br>
                        ‚Ä¢ Control and Coordination<br>
                        ‚Ä¢ Reproduction and Heredity<br><br>
                        Press <strong>1</strong> to ask about Life Processes<br>
                        Press <strong>2</strong> to ask about Control Systems<br>
                        Press <strong>9</strong> for direct question<br>
                        Press <strong>0</strong> to go back
                    </div>` :
                    `<div class="menu-text">
                        üå± <strong>‡∞ú‡±Ä‡∞µ ‡∞∂‡∞æ‡∞∏‡±ç‡∞§‡±ç‡∞∞ ‡∞µ‡∞ø‡∞∑‡∞Ø‡∞æ‡∞≤‡±Å</strong><br><br>
                        <strong>‡∞Ö‡∞Ç‡∞¶‡±Å‡∞¨‡∞æ‡∞ü‡±Å‡∞≤‡±ã ‡∞â‡∞®‡±ç‡∞® ‡∞µ‡∞ø‡∞∑‡∞Ø‡∞æ‡∞≤‡±Å:</strong><br>
                        ‚Ä¢ ‡∞ú‡±Ä‡∞µ ‡∞™‡±ç‡∞∞‡∞ï‡±ç‡∞∞‡∞ø‡∞Ø‡∞≤‡±Å (‡∞™‡±ã‡∞∑‡∞£, ‡∞∂‡±ç‡∞µ‡∞æ‡∞∏)<br>
                        ‚Ä¢ ‡∞®‡∞ø‡∞Ø‡∞Ç‡∞§‡±ç‡∞∞‡∞£ ‡∞Æ‡∞∞‡∞ø‡∞Ø‡±Å ‡∞∏‡∞Æ‡∞®‡±ç‡∞µ‡∞Ø‡∞Ç<br>
                        ‚Ä¢ ‡∞™‡±Å‡∞®‡∞∞‡±Å‡∞§‡±ç‡∞™‡∞§‡±ç‡∞§‡∞ø ‡∞Æ‡∞∞‡∞ø‡∞Ø‡±Å ‡∞µ‡∞Ç‡∞∂‡∞™‡∞æ‡∞∞‡∞Ç‡∞™‡∞∞‡±ç‡∞Ø‡∞§<br><br>
                        ‡∞ú‡±Ä‡∞µ ‡∞™‡±ç‡∞∞‡∞ï‡±ç‡∞∞‡∞ø‡∞Ø‡∞≤‡±Å ‡∞ó‡±Å‡∞∞‡∞ø‡∞Ç‡∞ö‡∞ø <strong>1</strong> ‡∞®‡±ä‡∞ï‡±ç‡∞ï‡∞Ç‡∞°‡∞ø<br>
                        ‡∞®‡∞ø‡∞Ø‡∞Ç‡∞§‡±ç‡∞∞‡∞£ ‡∞µ‡±ç‡∞Ø‡∞µ‡∞∏‡±ç‡∞•‡∞≤‡±Å ‡∞ó‡±Å‡∞∞‡∞ø‡∞Ç‡∞ö‡∞ø <strong>2</strong> ‡∞®‡±ä‡∞ï‡±ç‡∞ï‡∞Ç‡∞°‡∞ø<br>
                        ‡∞™‡±ç‡∞∞‡∞§‡±ç‡∞Ø‡∞ï‡±ç‡∞∑ ‡∞™‡±ç‡∞∞‡∞∂‡±ç‡∞® ‡∞ï‡±ã‡∞∏‡∞Ç <strong>9</strong> ‡∞®‡±ä‡∞ï‡±ç‡∞ï‡∞Ç‡∞°‡∞ø<br>
                        ‡∞µ‡±Ü‡∞®‡±Å‡∞ï‡∞ï‡±Å ‡∞µ‡±Ü‡∞≥‡±ç‡∞≤‡∞°‡∞æ‡∞®‡∞ø‡∞ï‡∞ø <strong>0</strong> ‡∞®‡±ä‡∞ï‡±ç‡∞ï‡∞Ç‡∞°‡∞ø
                    </div>`;

                updateScreenContent(message);

            } else if (key === '9') {
                // Switch to direct question mode
                const message = currentLanguage === 'english' ?
                    `<div class="menu-text">
                        üé§ <strong>Direct Question Mode</strong><br><br>
                        Please ask your Class 10 Science question clearly.<br><br>
                        You can use the demo questions below or speak your question.
                    </div>` :
                    `<div class="menu-text">
                        üé§ <strong>‡∞™‡±ç‡∞∞‡∞§‡±ç‡∞Ø‡∞ï‡±ç‡∞∑ ‡∞™‡±ç‡∞∞‡∞∂‡±ç‡∞® ‡∞Æ‡±ã‡∞°‡±ç</strong><br><br>
                        ‡∞¶‡∞Ø‡∞ö‡±á‡∞∏‡∞ø ‡∞Æ‡±Ä ‡∞ï‡±ç‡∞≤‡∞æ‡∞∏‡±ç 10 ‡∞∏‡±à‡∞®‡±ç‡∞∏‡±ç ‡∞™‡±ç‡∞∞‡∞∂‡±ç‡∞®‡∞®‡±Å ‡∞∏‡±ç‡∞™‡∞∑‡±ç‡∞ü‡∞Ç‡∞ó‡∞æ ‡∞Ö‡∞°‡∞ó‡∞Ç‡∞°‡∞ø.<br><br>
                        ‡∞Æ‡±Ä‡∞∞‡±Å ‡∞ï‡±ç‡∞∞‡∞ø‡∞Ç‡∞¶‡∞ø ‡∞°‡±Ü‡∞Æ‡±ã ‡∞™‡±ç‡∞∞‡∞∂‡±ç‡∞®‡∞≤‡∞®‡±Å ‡∞â‡∞™‡∞Ø‡±ã‡∞ó‡∞ø‡∞Ç‡∞ö‡∞µ‡∞ö‡±ç‡∞ö‡±Å ‡∞≤‡±á‡∞¶‡∞æ ‡∞Æ‡±Ä ‡∞™‡±ç‡∞∞‡∞∂‡±ç‡∞®‡∞®‡±Å ‡∞ö‡±Ü‡∞™‡±ç‡∞™‡∞µ‡∞ö‡±ç‡∞ö‡±Å.
                    </div>`;

                updateScreenContent(message);
                updateCallStatus('status-listening', 'Listening for Question');
                currentStep = 6; // Move to question recording

                // Show demo questions
                document.getElementById('demo-questions').style.display = 'block';

            } else if (key === '0') {
                // Go back to interaction mode
                const message = currentLanguage === 'english' ?
                    `<div class="menu-text">
                        üìö <strong>Class 10 Science Confirmed</strong><br><br>
                        How would you like to interact?<br><br>
                        Press <strong>1</strong> to browse topics<br>
                        Press <strong>2</strong> to ask a question directly
                    </div>` :
                    `<div class="menu-text">
                        üìö <strong>‡∞ï‡±ç‡∞≤‡∞æ‡∞∏‡±ç 10 ‡∞∏‡±à‡∞®‡±ç‡∞∏‡±ç ‡∞®‡∞ø‡∞∞‡±ç‡∞ß‡∞æ‡∞∞‡∞ø‡∞Ç‡∞ö‡∞¨‡∞°‡∞ø‡∞Ç‡∞¶‡∞ø</strong><br><br>
                        ‡∞Æ‡±Ä‡∞∞‡±Å ‡∞é‡∞≤‡∞æ ‡∞∏‡∞Ç‡∞≠‡∞æ‡∞∑‡∞ø‡∞Ç‡∞ö‡∞æ‡∞≤‡∞®‡±Å‡∞ï‡±Å‡∞Ç‡∞ü‡±Å‡∞®‡±ç‡∞®‡∞æ‡∞∞‡±Å?<br><br>
                        ‡∞µ‡∞ø‡∞∑‡∞Ø‡∞æ‡∞≤‡±Å ‡∞ö‡±Ç‡∞°‡∞ü‡∞æ‡∞®‡∞ø‡∞ï‡∞ø <strong>1</strong> ‡∞®‡±ä‡∞ï‡±ç‡∞ï‡∞Ç‡∞°‡∞ø<br>
                        ‡∞™‡±ç‡∞∞‡∞§‡±ç‡∞Ø‡∞ï‡±ç‡∞∑‡∞Ç‡∞ó‡∞æ ‡∞™‡±ç‡∞∞‡∞∂‡±ç‡∞® ‡∞Ö‡∞°‡∞ó‡∞°‡∞æ‡∞®‡∞ø‡∞ï‡∞ø <strong>2</strong> ‡∞®‡±ä‡∞ï‡±ç‡∞ï‡∞Ç‡∞°‡∞ø
                    </div>`;

                updateScreenContent(message);
                updateCallStatus('status-connected', 'Interaction Mode');
                currentStep = 4; // Back to interaction mode
            }
        }

        function handleFollowUp(key) {
            if (key === '1') {
                // Ask another question
                const message = currentLanguage === 'english' ?
                    `<div class="menu-text">
                        üé§ <strong>Ready for Next Question</strong><br><br>
                        Please ask your next Class 10 Science question.
                    </div>` :
                    `<div class="menu-text">
                        üé§ <strong>‡∞§‡∞¶‡±Å‡∞™‡∞∞‡∞ø ‡∞™‡±ç‡∞∞‡∞∂‡±ç‡∞®‡∞ï‡±Å ‡∞∏‡∞ø‡∞¶‡±ç‡∞ß‡∞Ç</strong><br><br>
                        ‡∞¶‡∞Ø‡∞ö‡±á‡∞∏‡∞ø ‡∞Æ‡±Ä ‡∞§‡∞¶‡±Å‡∞™‡∞∞‡∞ø ‡∞ï‡±ç‡∞≤‡∞æ‡∞∏‡±ç 10 ‡∞∏‡±à‡∞®‡±ç‡∞∏‡±ç ‡∞™‡±ç‡∞∞‡∞∂‡±ç‡∞®‡∞®‡±Å ‡∞Ö‡∞°‡∞ó‡∞Ç‡∞°‡∞ø.
                    </div>`;

                updateScreenContent(message);
                updateCallStatus('status-listening', 'Listening for Question');
                currentStep = 6; // Back to question recording
                document.getElementById('demo-questions').style.display = 'block';
                document.getElementById('response-display').style.display = 'none';

            } else if (key === '9') {
                // Main menu
                playWelcomeMessage();
            } else if (key === '0') {
                // End call
                endCall();
            }
        }

        async function askDemoQuestion(question) {
            if (!callActive || isProcessing) return;

            isProcessing = true;
            document.getElementById('demo-questions').style.display = 'none';

            // Show processing
            updateCallStatus('status-processing', 'AI Processing Question');
            updateFlowStep(7);

            updateScreenContent(`
                <div class="menu-text">
                    <strong>Question Received:</strong><br>
                    "${question}"<br><br>
                    ü§ñ AI is processing your question...
                </div>
            `);

            document.getElementById('processing-indicator').style.display = 'block';

            try {
                console.log('ü§ñ Processing question:', question);
                showNetworkActivity('Processing question: ' + question.substring(0, 30) + '...');

                // Add question to session
                if (sessionId) {
                    await fetch(`${API_BASE}/api/session/${encodeURIComponent(phoneNumber)}/question`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            question: question,
                            timestamp: new Date().toISOString()
                        })
                    });
                }

                // Use demo response endpoint (optimized for text questions)
                const demoResponse = await fetch(`${API_BASE}/api/demo/response`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        question: question,
                        language: currentLanguage,
                        session_id: sessionId
                    })
                });

                let responseData;
                if (demoResponse.ok) {
                    responseData = await demoResponse.json();
                    console.log('‚úÖ AI response received:', responseData);
                    showNetworkActivity('AI response generated successfully');
                } else {
                    throw new Error('Failed to get AI response: ' + demoResponse.status);
                }

                // Add response to session
                if (sessionId && responseData.response) {
                    await fetch(`${API_BASE}/api/session/${encodeURIComponent(phoneNumber)}/response`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            response: responseData.response,
                            timestamp: new Date().toISOString()
                        })
                    });
                }

                if (responseData.response) {
                    currentResponse = responseData.response;
                    showResponse(question, responseData.response);
                    
                    // Get performance metrics
                    fetchPerformanceMetrics();
                } else {
                    showError("Sorry, I don't have information about that topic. Please try another question.");
                }

            } catch (error) {
                console.error('‚ùå Error processing question:', error);
                showNetworkActivity('Question processing failed: ' + error.message);
                showError("There was an error processing your question. Please try again.");
            }

            isProcessing = false;
            document.getElementById('processing-indicator').style.display = 'none';
        }

        function showResponse(question, response) {
            updateCallStatus('status-connected', 'Response Ready');
            updateFlowStep(8);

            updateScreenContent(`
                <div class="menu-text">
                    <strong>Q:</strong> ${question}<br><br>
                    <strong>ü§ñ VidyaVani AI Response:</strong><br>
                    ${response}
                </div>
            `);

            document.getElementById('response-text').textContent = response;
            document.getElementById('response-display').style.display = 'block';

            // Show follow-up menu after a delay
            setTimeout(() => {
                showFollowUpMenu();
            }, 3000);
        }

        function showFollowUpMenu() {
            updateFlowStep(9);

            const message = currentLanguage === 'english' ?
                `<div class="menu-text">
                    <strong>What would you like to do next?</strong><br><br>
                    Press <strong>1</strong> to ask another question<br>
                    Press <strong>9</strong> for main menu<br>
                    Press <strong>0</strong> to end call
                </div>` :
                `<div class="menu-text">
                    <strong>‡∞Æ‡±Ä‡∞∞‡±Å ‡∞§‡∞∞‡±ç‡∞µ‡∞æ‡∞§ ‡∞è‡∞Æ‡∞ø ‡∞ö‡±á‡∞Ø‡∞æ‡∞≤‡∞®‡±Å‡∞ï‡±Å‡∞Ç‡∞ü‡±Å‡∞®‡±ç‡∞®‡∞æ‡∞∞‡±Å?</strong><br><br>
                    ‡∞Æ‡∞∞‡±ã ‡∞™‡±ç‡∞∞‡∞∂‡±ç‡∞® ‡∞Ö‡∞°‡∞ó‡∞°‡∞æ‡∞®‡∞ø‡∞ï‡∞ø <strong>1</strong> ‡∞®‡±ä‡∞ï‡±ç‡∞ï‡∞Ç‡∞°‡∞ø<br>
                    ‡∞Æ‡±Ü‡∞Ø‡∞ø‡∞®‡±ç ‡∞Æ‡±Ü‡∞®‡±Ç‡∞ï‡∞ø <strong>9</strong> ‡∞®‡±ä‡∞ï‡±ç‡∞ï‡∞Ç‡∞°‡∞ø<br>
                    ‡∞ï‡∞æ‡∞≤‡±ç ‡∞Æ‡±Å‡∞ó‡∞ø‡∞Ç‡∞ö‡∞°‡∞æ‡∞®‡∞ø‡∞ï‡∞ø <strong>0</strong> ‡∞®‡±ä‡∞ï‡±ç‡∞ï‡∞Ç‡∞°‡∞ø
                </div>`;

            updateScreenContent(message);
        }

        function showError(message) {
            updateCallStatus('status-connected', 'Error Occurred');

            updateScreenContent(`
                <div class="menu-text" style="border-left-color: #f44336; background: rgba(244, 67, 54, 0.1);">
                    ‚ùå <strong>Error:</strong><br>
                    ${message}<br><br>
                    Press <strong>1</strong> to try again<br>
                    Press <strong>9</strong> for main menu
                </div>
            `);
        }

        async function speakResponse(text) {
            return new Promise((resolve) => {
                if (!text) {
                    resolve();
                    return;
                }

                console.log('üîä Speaking response...');
                showNetworkActivity('Playing TTS audio response');

                // Cancel any ongoing speech
                speechSynthesis.cancel();

                const utterance = new SpeechSynthesisUtterance(text);
                utterance.rate = 0.9;
                utterance.pitch = 1.0;
                utterance.lang = currentLanguage === 'telugu' ? 'te-IN' : 'en-IN';
                utterance.volume = 1.0;

                utterance.onstart = () => {
                    console.log('üîä TTS started');
                    updateCallStatus('status-connected', 'Playing Response');
                };

                utterance.onend = () => {
                    console.log('üîä TTS completed');
                    showNetworkActivity('TTS playback completed');
                    resolve();
                };

                utterance.onerror = (event) => {
                    console.error('TTS error:', event.error);
                    showNetworkActivity('TTS error: ' + event.error);
                    resolve();
                };

                speechSynthesis.speak(utterance);
            });
        }

        function playResponse() {
            if (!currentResponse) return;
            speakResponse(currentResponse);
        }

        function updateCallStatus(statusClass, statusText) {
            const indicator = document.getElementById('call-status-indicator');
            const text = document.getElementById('call-status-text');

            indicator.className = `status-indicator ${statusClass}`;
            text.textContent = statusText;
        }

        function updateScreenContent(content) {
            document.getElementById('screen-content').innerHTML = content;
        }

        function updateFlowStep(step) {
            currentStep = step;

            // Update flow step indicators
            document.querySelectorAll('.flow-step').forEach((el, index) => {
                el.classList.toggle('active', index === step);
            });
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // Voice Recording with Browser Speech Recognition
        let recognition;
        let isRecording = false;

        function initializeSpeechRecognition() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            
            if (!SpeechRecognition) {
                console.warn('Speech Recognition not supported');
                return null;
            }

            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.lang = currentLanguage === 'telugu' ? 'te-IN' : 'en-IN';

            recognition.onstart = () => {
                console.log('üé§ Listening...');
                showNetworkActivity('Listening for voice input...');
            };

            recognition.onresult = async (event) => {
                const transcript = event.results[0][0].transcript;
                console.log('üé§ Recognized:', transcript);
                showNetworkActivity('Recognized: "' + transcript + '"');
                await processVoiceQuestion(transcript);
            };

            recognition.onerror = (event) => {
                console.error('Speech error:', event.error);
                showNetworkActivity('Speech error: ' + event.error);
                isRecording = false;
                updateRecordButton(false);
                
                if (event.error === 'not-allowed') {
                    alert('Microphone access denied. Please allow microphone access.');
                }
            };

            recognition.onend = () => {
                isRecording = false;
                updateRecordButton(false);
            };

            return recognition;
        }

        async function toggleRecording() {
            if (!isRecording) {
                if (!recognition) {
                    recognition = initializeSpeechRecognition();
                    if (!recognition) {
                        alert('Speech recognition not supported. Please use Chrome, Edge, or Safari.');
                        return;
                    }
                }

                try {
                    recognition.lang = currentLanguage === 'telugu' ? 'te-IN' : 'en-IN';
                    recognition.start();
                    isRecording = true;
                    updateRecordButton(true);
                } catch (error) {
                    console.error('Error starting recording:', error);
                    alert('Could not start recording. Please try again.');
                }
            } else {
                if (recognition) recognition.stop();
                isRecording = false;
                updateRecordButton(false);
            }
        }

        function updateRecordButton(recording) {
            const btn = document.getElementById('record-btn');
            const status = document.getElementById('recording-status');
            
            if (recording) {
                btn.textContent = 'üõë Stop Recording';
                btn.style.background = 'rgba(76, 175, 80, 0.2)';
                btn.style.borderColor = '#4CAF50';
                status.style.display = 'block';
                status.textContent = 'üî¥ Listening... Speak your question now';
            } else {
                btn.textContent = 'üé§ Click to Record Your Question';
                btn.style.background = 'rgba(244, 67, 54, 0.2)';
                btn.style.borderColor = '#f44336';
                status.style.display = 'none';
            }
        }

        async function processVoiceQuestion(questionText) {
            if (!callActive || isProcessing) return;

            isProcessing = true;
            document.getElementById('demo-questions').style.display = 'none';

            // Show processing
            updateCallStatus('status-processing', 'Processing Voice Question');
            updateFlowStep(7);

            updateScreenContent(`
                <div class="menu-text">
                    <strong>Voice Question Received:</strong><br>
                    "${questionText}"<br><br>
                    ü§ñ AI is processing your question...
                </div>
            `);

            document.getElementById('processing-indicator').style.display = 'block';

            try {
                console.log('üé§ Processing voice question:', questionText);
                showNetworkActivity('Processing: "' + questionText.substring(0, 40) + '..."');

                // Add question to session
                if (sessionId) {
                    await fetch(`${API_BASE}/api/session/${encodeURIComponent(phoneNumber)}/question`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            question: questionText,
                            type: 'voice_recording',
                            timestamp: new Date().toISOString()
                        })
                    });
                }

                // Get AI response from backend
                const response = await fetch(`${API_BASE}/api/demo/response`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        question: questionText,
                        language: currentLanguage,
                        session_id: sessionId
                    })
                });

                const responseData = await response.json();
                console.log('‚úÖ AI response received:', responseData);

                if (responseData.response) {
                    currentResponse = responseData.response;
                    showNetworkActivity('AI response generated successfully');
                    
                    // Add response to session
                    if (sessionId) {
                        await fetch(`${API_BASE}/api/session/${encodeURIComponent(phoneNumber)}/response`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ 
                                response: responseData.response,
                                timestamp: new Date().toISOString()
                            })
                        });
                    }
                    
                    showResponse(questionText, responseData.response);
                    
                    // Automatically speak the response
                    await speakResponse(responseData.response);
                    
                    // Get performance metrics
                    fetchPerformanceMetrics();
                } else {
                    showError("Sorry, I don't have information about that topic. Please try another question.");
                }

            } catch (error) {
                console.error('‚ùå Error processing voice question:', error);
                showNetworkActivity('Voice processing failed: ' + error.message);
                showError("There was an error processing your voice question. Please try again.");
            }

            isProcessing = false;
            document.getElementById('processing-indicator').style.display = 'none';
        }

        // Network Activity Monitoring
        function showNetworkActivity(message) {
            const networkLog = document.getElementById('network-log');
            if (networkLog) {
                const timestamp = new Date().toLocaleTimeString();
                const logEntry = document.createElement('div');
                logEntry.className = 'network-entry';
                logEntry.innerHTML = `<span class="timestamp">${timestamp}</span> ${message}`;
                networkLog.appendChild(logEntry);
                networkLog.scrollTop = networkLog.scrollHeight;
                
                // Keep only last 10 entries
                while (networkLog.children.length > 10) {
                    networkLog.removeChild(networkLog.firstChild);
                }
            }
            console.log('üåê Network:', message);
        }

        // Performance Metrics
        async function fetchPerformanceMetrics() {
            try {
                const response = await fetch(`${API_BASE}/api/performance/metrics`);
                const metrics = await response.json();
                console.log('üìä Performance metrics:', metrics);
                showNetworkActivity('Performance metrics updated');
                updatePerformanceDisplay(metrics);
            } catch (error) {
                console.error('Failed to fetch performance metrics:', error);
            }
        }

        function updatePerformanceDisplay(metrics) {
            const perfDisplay = document.getElementById('performance-display');
            if (perfDisplay && metrics.api_metrics) {
                const geminiMetrics = metrics.api_metrics.gemini || {};
                const sttMetrics = metrics.api_metrics.google_stt || {};
                
                perfDisplay.innerHTML = `
                    <div class="metric-item">ü§ñ AI Requests: ${geminiMetrics.total_requests || 0}</div>
                    <div class="metric-item">üé§ STT Requests: ${sttMetrics.total_requests || 0}</div>
                    <div class="metric-item">üìû Session: ${sessionId ? sessionId.substring(0, 8) + '...' : 'None'}</div>
                `;
            }
        }

        // End call with backend cleanup
        async function endCall() {
            if (!callActive) return;

            try {
                // End session in backend
                if (sessionId) {
                    await fetch(`${API_BASE}/api/session/${encodeURIComponent(phoneNumber)}/end`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            end_reason: 'user_hangup',
                            timestamp: new Date().toISOString()
                        })
                    });
                    
                    showNetworkActivity('Session ended: ' + sessionId);
                }

                // Call webhook for call end
                await fetch(`${API_BASE}/webhook/call-end`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams({
                        'From': phoneNumber,
                        'CallSid': sessionId,
                        'CallStatus': 'completed'
                    })
                });

            } catch (error) {
                console.error('‚ùå Call end failed:', error);
                showNetworkActivity('Call end error: ' + error.message);
            }

            callActive = false;
            currentStep = 0;
            isProcessing = false;
            sessionId = null;

            document.getElementById('start-call-btn').style.display = 'block';
            document.getElementById('end-call-btn').style.display = 'none';
            document.getElementById('demo-questions').style.display = 'none';
            document.getElementById('response-display').style.display = 'none';
            document.getElementById('processing-indicator').style.display = 'none';

            updateCallStatus('status-connected', 'Call Ended');
            updateFlowStep(0);

            setTimeout(() => {
                updateCallStatus('status-connected', 'Ready to Call');
                updateScreenContent(`
                    <div class="menu-text">
                        <strong>Welcome to VidyaVani!</strong><br>
                        Your AI-powered learning assistant for Class 10 Science.<br><br>
                        Press the <strong>üìû CALL</strong> button to start your learning session.
                    </div>
                `);
            }, 2000);
        }

        // Keyboard shortcuts for demo
        document.addEventListener('keydown', function (e) {
            if (e.key >= '0' && e.key <= '9') {
                pressKey(e.key);
            } else if (e.key === '*') {
                pressKey('*');
            } else if (e.key === '#') {
                pressKey('#');
            } else if (e.key === 'Enter' && !callActive) {
                startCall();
            } else if (e.key === 'Escape' && callActive) {
                endCall();
            }
        });
        // Developer Console Functions
        let apiCallCount = 0;
        let consoleVisible = true;

        function toggleConsole() {
            const console = document.querySelector('.developer-console');
            const content = document.getElementById('console-content');
            if (consoleVisible) {
                content.style.display = 'none';
                consoleVisible = false;
            } else {
                content.style.display = 'block';
                consoleVisible = true;
            }
        }

        function updateDeveloperConsole() {
            document.getElementById('backend-status').textContent = 'üü¢ vidyavani.onrender.com';
            document.getElementById('session-display').textContent = sessionId ? sessionId.substring(0, 12) + '...' : 'None';
            document.getElementById('phone-display').textContent = phoneNumber;
            document.getElementById('api-calls-count').textContent = `${apiCallCount} total calls`;
        }

        // Override fetch to count API calls
        const originalFetch = window.fetch;
        window.fetch = function(...args) {
            if (args[0].includes('vidyavani.onrender.com')) {
                apiCallCount++;
                updateDeveloperConsole();
                console.log(`üåê API Call #${apiCallCount}:`, args[0]);
            }
            return originalFetch.apply(this, args);
        };

        // Update console every 2 seconds
        setInterval(updateDeveloperConsole, 2000);

    </script>

    <!-- Developer Console for Evaluators -->
    <div class="developer-console" style="position: fixed; bottom: 20px; left: 20px; background: rgba(0,0,0,0.9); color: #00ff00; padding: 15px; border-radius: 8px; font-family: 'Courier New', monospace; font-size: 0.8em; max-width: 400px; border: 1px solid #00ff00; z-index: 1000;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <h4 style="margin: 0; color: #00ff00;">üîß Developer Console</h4>
            <button onclick="toggleConsole()" style="background: none; border: 1px solid #00ff00; color: #00ff00; padding: 2px 8px; border-radius: 3px; cursor: pointer;">Toggle</button>
        </div>
        <div id="console-content">
            <div><strong>Backend:</strong> <span id="backend-status">üîÑ Checking...</span></div>
            <div><strong>Session:</strong> <span id="session-display">None</span></div>
            <div><strong>Phone:</strong> <span id="phone-display">Not assigned</span></div>
            <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #333;">
                <div><strong>API Calls Made:</strong></div>
                <div id="api-calls-count" style="font-size: 0.9em; color: #4CAF50;">0 total calls</div>
            </div>
            <div style="margin-top: 8px; font-size: 0.8em; color: #888;">
                üí° Open Network Tab (F12) to see all API calls
            </div>
        </div>
    </div>

</body>

</html>